# üß† NORMALIZATION_RULES ‚Äî MVP (Dictionary-driven + Manual Review)

## 0) –¶–µ–ª—å

–°—Ç–∞–±–∏–ª—å–Ω–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ (`supplier_items`) —Å –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–º–∏ SKU (`normalized_skus`), —á—Ç–æ–±—ã:
- –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ—Ñ—Ñ–µ—Ä—ã (`offers`) —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ confirmed mapping,
- –±—ã—Å—Ç—Ä–æ —á–∏–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —Å–ª–æ–≤–∞—Ä—å (–±–µ–∑ –ø—Ä–∞–≤–æ–∫ raw),
- –∏–º–µ—Ç—å —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π —Ä—É—á–Ω–æ–π —Ä–∞–∑–±–æ—Ä (–æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á).

---

## 1) –ü—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è MVP

1) **SKU ‚â† Offer**
- SKU ‚Äî ‚Äú—á—Ç–æ —ç—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä‚Äù (—Ç–∏–ø + —Å–æ—Ä—Ç/–ª–∏–Ω–µ–π–∫–∞ + –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ü–≤–µ—Ç/–ø–æ–¥—Ç–∏–ø).
- Offer ‚Äî ‚Äú–∫–∞–∫ –ø—Ä–æ–¥–∞—ë—Ç—Å—è‚Äù (–¥–ª–∏–Ω–∞, —É–ø–∞–∫–æ–≤–∫–∞, –∫—Ä–∞—Ç–Ω–æ—Å—Ç—å, —Ü–µ–Ω–∞, —Ç–∏—Ä—ã).

2) **–î–ª–∏–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Offer**, –∞ –Ω–µ –≤ SKU.  
–ò—Å–∫–ª—é—á–µ–Ω–∏–µ: –µ—Å–ª–∏ —Ä—ã–Ω–æ–∫ —É –∑–∞–∫–∞–∑—á–∏–∫–∞ —Ç—Ä–µ–±—É–µ—Ç SKU ‚Äú–†–æ–∑–∞ 60—Å–º Explorer‚Äù –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É ‚Äî —Ç–æ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º length –≤ SKU (–Ω–æ —ç—Ç–æ —É—Å–ª–æ–∂–Ω—è–µ—Ç –∫–∞—Ç–∞–ª–æ–≥).

3) –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **—Å–ª–æ–≤–∞—Ä—ë–º (dictionary_entries)** + —Ä—É—á–Ω—ã–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º.

---

## 2) –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å SKU (—á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º)

### 2.1 –ü–æ–ª—è normalized_sku (MVP)
- `product_type` (–æ–±—è–∑.) ‚Äî rose / carnation / alstroemeria / chrysanthemum / greens / packaging / etc.
- `variety` (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ) ‚Äî —Å–æ—Ä—Ç/–ª–∏–Ω–µ–π–∫–∞ (Explorer, Mondial, Pink Floyd‚Ä¶)
- `color` (–æ–ø—Ü.) ‚Äî –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤ –¥–∞–Ω–Ω—ã—Ö
- `title` ‚Äî —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
- `meta` (json) ‚Äî –¥–æ–ø. –∞—Ç—Ä–∏–±—É—Ç—ã:
  - `subtype`: spray / bush / standard / premium / etc
  - `origin_default`: Ecuador / Colombia / Netherlands / Kenya / Israel (–µ—Å–ª–∏ –¥–ª—è SKU –≤–∞–∂–Ω–æ)
  - `brand_farm`: PIANGOFLOR / FRAMA FLOWERS (–µ—Å–ª–∏ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—É—â–Ω–æ—Å—Ç—å)

> –í MVP: —Å—Ç—Ä–∞–Ω–∞/—Ñ–µ—Ä–º–∞ —á–∞—â–µ –∏–¥—É—Ç –∫–∞–∫ –∞—Ç—Ä–∏–±—É—Ç Offer/Source, –∞ –Ω–µ SKU.  
–ù–æ –¥–æ–ø—É—Å–∫–∞–µ–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ meta, –µ—Å–ª–∏ –∑–∞–∫–∞–∑—á–∏–∫ —Ç—Ä–µ–±—É–µ—Ç ‚Äú—Ä–∞–∑–Ω—ã–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏‚Äù –Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å.

---

## 3) Dictionary –∏ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤

### 3.0 –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤ (NEW)

–ü–æ–º–∏–º–æ `dictionary_entries`, —Å–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤** –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:

```
flower_categories (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    ‚îî‚îÄ‚îÄ flower_types (–†–æ–∑–∞, –•—Ä–∏–∑–∞–Ω—Ç–µ–º–∞, –≠–≤–∫–∞–ª–∏–ø—Ç)
          ‚îú‚îÄ‚îÄ flower_subtypes (–ö—É—Å—Ç–æ–≤–∞—è, –°–ø—Ä–µ–π, –ü–∏–æ–Ω–æ–≤–∏–¥–Ω–∞—è)
          ‚îÇ     ‚îî‚îÄ‚îÄ subtype_synonyms
          ‚îú‚îÄ‚îÄ type_synonyms (—Ä–æ–∑–∞, —Ä–æ–∑—ã, rose ‚Üí –†–æ–∑–∞)
          ‚îî‚îÄ‚îÄ flower_varieties (Explorer, Freedom, Red Naomi)
                ‚îî‚îÄ‚îÄ variety_synonyms (—ç–∫—Å–ø–ª–æ—Ä–µ—Ä ‚Üí Explorer)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞:**
- –°—É–±—Ç–∏–ø—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —Ç–∏–ø–∞–º (–∫—É—Å—Ç–æ–≤–∞—è —Ä–æ–∑–∞ vs –∫—É—Å—Ç–æ–≤–∞—è —Ö—Ä–∏–∑–∞–Ω—Ç–µ–º–∞)
- –°–æ—Ä—Ç–∞ —Å–≤—è–∑–∞–Ω—ã —Å —Ç–∏–ø–æ–º/—Å—É–±—Ç–∏–ø–æ–º
- –°–∏–Ω–æ–Ω–∏–º—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
- –¢—Ä–∏–≥—Ä–∞–º–º–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è fuzzy search —Å–æ—Ä—Ç–æ–≤
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞

**API –∫–∞—Ç–∞–ª–æ–≥–∞:** `GET /admin/catalog/lookup` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä–∏ –¥–ª—è –ø–∞—Ä—Å–µ—Ä–∞.

### 3.1 dictionary_entries (legacy)

`dictionary_entries` —Ö—Ä–∞–Ω–∏—Ç "—É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –∑–Ω–∞–Ω–∏—è" –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ (—Ü–≤–µ—Ç–∞, —Å—Ç—Ä–∞–Ω—ã, pack_type).

**–û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø–∏—Å–∏:**
- `dict_type`: —Å—Ç—Ä–æ–∫–∞ (—Ç–∏–ø —Å–ª–æ–≤–∞—Ä—è)
- `key`: –∫–ª—é—á
- `value`: –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- `synonyms`: –º–∞—Å—Å–∏–≤ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
- `rules`: json —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ (regex/replace/extract)
- `status`: active/deprecated

> **Note:** –¢–∏–ø—ã —Ü–≤–µ—Ç–æ–≤ (product_type) —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `flower_types` + `type_synonyms`.
> `dictionary_entries` –æ—Å—Ç–∞—ë—Ç—Å—è –¥–ª—è: country, pack_type, stopwords, regex_rule, variety_alias.

### 3.2 –ù–∞–±–æ—Ä dict_type –¥–ª—è MVP

> **UPDATE:** `product_type` —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `flower_types` + `type_synonyms`.
> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ API `/admin/catalog/types` –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —Ü–≤–µ—Ç–æ–≤.

1) ~~`product_type`~~ ‚Üí **–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ `flower_types`**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/admin/catalog/types` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –ü—Ä–∏–º–µ—Ä: "–†–æ–∑–∞" —Å —Å–∏–Ω–æ–Ω–∏–º–∞–º–∏ ["—Ä–æ–∑–∞", "—Ä–æ–∑—ã", "rose", "roses"]

2) `country`
- key: "—ç–∫–≤–∞–¥–æ—Ä"
- value: "Ecuador"
- synonyms: ["ecuador", "(—ç–∫–≤–∞–¥–æ—Ä)", "—ç–∫–≤."]

3) `pack_type`
- key: "–±–∞–∫"
- value: "bak"
- synonyms: ["–±–∞–∫.", "bucket", "–≤–µ–¥—Ä–æ"]
- key: "—É–ø–∞–∫"
- value: "pack"
- synonyms: ["—É–ø–∞–∫.", "—É–ø–∞–∫–æ–≤–∫–∞", "bunch", "box"]

4) `stopwords`
- key/value: –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ (—É–¥–∞–ª—è–µ–º—ã–µ —Ç–æ–∫–µ–Ω—ã)
- –ø—Ä–∏–º–µ—Ä—ã: ["–∏–º–ø–æ—Ä—Ç", "—Å–æ—Ä—Ç–æ–≤—ã–µ", "–ø–æ—Å—Ç–∞–≤–∫–∞", "—Ü–µ–Ω–∞", "—Ä—É–±", "—Ä", "—Å–º", "cm"]

5) `regex_rule`
- –ø—Ä–∞–≤–∏–ª–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∞—Ç—Ä–∏–±—É—Ç–æ–≤ (—Å–º. –±–ª–æ–∫ 4)

6) `variety_alias`
- –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–æ—Ä—Ç–æ–≤: key=–ª—é–±–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –Ω–∞–ø–∏—Å–∞–Ω–∏—è ‚Üí value=–∫–∞–Ω–æ–Ω
- –ø—Ä–∏–º–µ—Ä: key="mondial" value="Mondial" synonyms=["–º–æ–Ω–¥–∏–∞–ª—å","mondial¬Æ"]

> –ù–∞ —Å—Ç–∞—Ä—Ç–µ `variety_alias` –º–æ–∂–Ω–æ –Ω–∞–ø–æ–ª–Ω—è—Ç—å –ø–æ –º–µ—Ä–µ —Ä—É—á–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞ —Ç–æ–ø-100 —Å–æ—Ä—Ç–æ–≤.

---

## 4) –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ (parsing rules)

**–í–∞–∂–Ω–æ:** —á–∞—Å—Ç—å –∞—Ç—Ä–∏–±—É—Ç–æ–≤ (length, pack_type) –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ —É–∂–µ –≤ `offer_candidates` –∏–∑ –º–∞—Ç—Ä–∏—Ü/—Ç–∏—Ä–æ–≤.  
–¢–æ–≥–¥–∞ –∏–∑ `raw_name` –∏—Ö –Ω–µ –∏–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ, –∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ ‚Äúsource of truth‚Äù.

### 4.1 –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (preprocess)
–ü–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏:
- lower()
- trim
- –∑–∞–º–µ–Ω–∏—Ç—å "‚Äì" –∏ "‚Äî" –Ω–∞ "-"
- –∑–∞–º–µ–Ω–∏—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –æ–¥–∏–Ω
- —É–±—Ä–∞—Ç—å —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (—Ç–∞–±/–ø–µ—Ä–µ–≤–æ–¥—ã —Å—Ç—Ä–æ–∫)
- —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å "—Å–º" / "cm"
- —É–¥–∞–ª–∏—Ç—å –≤–∞–ª—é—Ç—É: "—Ä—É–±", "—Ä", "‚ÇΩ" (–µ—Å–ª–∏ –ø–æ–ø–∞–ª–æ –≤ name)

### 4.2 Regex: –¥–ª–∏–Ω–∞ (length_cm)
–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ length_cm –µ—â—ë –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω –≤ offer_candidate:

- `(?<!\d)(\d{2,3})\s*(—Å–º|cm)\b`
- `\b(\d{2,3})\s*—Å–º\b`
- `\b(\d{2,3})\b(?=\s*—Å–º)` (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)

–ü–æ—Å—Ç-–≤–∞–ª–∏–¥–∞—Ü–∏—è:
- –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –¥–ª–∏–Ω—ã: 30‚Äì120 (–∏–Ω–∞—á–µ warn)

### 4.3 Regex: —Å—Ç—Ä–∞–Ω–∞ (origin_country)
- `\((—ç–∫–≤–∞–¥–æ—Ä|–∫–æ–ª—É–º–±–∏—è|–≥–æ–ª–ª–∞–Ω–¥–∏—è|–Ω–∏–¥–µ—Ä–ª–∞–Ω–¥—ã|–∫–µ–Ω–∏—è|–∏–∑—Ä–∞–∏–ª—å)\)`
- `\b(—ç–∫–≤–∞–¥–æ—Ä|–∫–æ–ª—É–º–±–∏—è|–≥–æ–ª–ª–∞–Ω–¥–∏—è|–Ω–∏–¥–µ—Ä–ª–∞–Ω–¥—ã|–∫–µ–Ω–∏—è|–∏–∑—Ä–∞–∏–ª—å)\b`
–ú–∞–ø–ø–∏–º —á–µ—Ä–µ–∑ dict_type=country.

### 4.4 Regex: —É–ø–∞–∫–æ–≤–∫–∞ (pack_qty / pack_type)
- pack_qty:
  - `\((\d{1,3})\)\s*$`  (–≤ –∫–æ–Ω—Ü–µ)
  - `\((\d{1,3})\s*—à—Ç\)`  
  - `\b(\d{1,3})\s*—à—Ç\b` (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ: –º–æ–∂–µ—Ç –±—ã—Ç—å ‚Äú100 —à—Ç‚Äù –∫–∞–∫ tier ‚Äî –Ω–µ –ø—É—Ç–∞—Ç—å)
- pack_type:
  - `\b(–±–∞–∫|—É–ø–∞–∫)\b` –∏–ª–∏ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –º–∞—Ç—Ä–∏—Ü—ã

–ü–æ—Å—Ç-–ª–æ–≥–∏–∫–∞:
- –µ—Å–ª–∏ `pack_qty` –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 5‚Äì50 ‚Üí —Ç—Ä–∞–∫—Ç—É–µ–º –∫–∞–∫ ‚Äú–∫—Ä–∞—Ç–Ω–æ—Å—Ç—å/—É–ø–∞–∫–æ–≤–∫–∞‚Äù
- –µ—Å–ª–∏ –±–æ–ª—å—à–∏–µ —á–∏—Å–ª–∞ (>=80) —Ä—è–¥–æ–º —Å ‚Äú—à—Ç‚Äù ‚Üí –≤–µ—Ä–æ—è—Ç–Ω–æ tier, –Ω–µ pack_qty (warn)

### 4.5 Regex: –ø–æ–¥—Ç–∏–ø/–∫–∞—á–µ—Å—Ç–≤–æ/—Ñ–æ—Ä–º–∞ (subtype/grade)
–ö–ª—é—á–µ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã:
- `—Å–ø—Ä–µ–π|spray` ‚Üí subtype=spray
- `–∫—É—Å—Ç–æ–≤–∞—è` ‚Üí subtype=bush
- `—Å—Ç–∞–Ω–¥–∞—Ä—Ç|standard` ‚Üí grade=standard
- `–ø—Ä–µ–º–∏—É–º|premium` ‚Üí grade=premium
- `–º–∏–∫—Å|mix` ‚Üí subtype=mix (—Ç—Ä–µ–±—É–µ—Ç –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏, —á–∞—Å—Ç–æ —ç—Ç–æ –Ω–µ SKU)

---

## 5) –ê–ª–≥–æ—Ä–∏—Ç–º propose (–∞–≤—Ç–æ–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞)

–í—Ö–æ–¥: `supplier_item` (raw_name, raw_group, name_norm, attributes)  
–í—ã—Ö–æ–¥: –∑–∞–ø–∏—Å–∏ `sku_mappings` —Å–æ status=proposed –∏ confidence.

### 5.1 –®–∞–≥–∏ propose
1) **Context merge**
- –±–µ—Ä—ë–º `raw_group` (–∫–∞—Ç–µ–≥–æ—Ä–∏—è/—Å—Ç—Ä–∞–Ω–∞/—Ä–∞–∑–¥–µ–ª) –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–æ–∫–µ–Ω–æ–≤
- –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Å `raw_name`

2) **Extract attributes**
- –ø—Ä–∏–º–µ–Ω—è–µ–º regex_rule: –¥–ª–∏–Ω–∞/—Å—Ç—Ä–∞–Ω–∞/—É–ø–∞–∫–æ–≤–∫–∞/–ø–æ–¥—Ç–∏–ø/grade/–±—Ä–µ–Ω–¥
- —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ `supplier_items.attributes`

3) **Detect product_type** (–∏–∑ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞)
–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
- –∏–∑ raw_group (–µ—Å–ª–∏ –æ–Ω "–†–æ–∑—ã/–ì–≤–æ–∑–¥–∏–∫–∞/–ó–µ–ª–µ–Ω—å/‚Ä¶")
- –∏–Ω–∞—á–µ –ø–æ `flower_types` + `type_synonyms` (–∏–∑ –ë–î —Å –∫—ç—à–µ–º TTL=5–º–∏–Ω)
- fallback –Ω–∞ hardcoded FLOWER_TYPES_FALLBACK

4) **Detect subtype** (NEW)
- –ü–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è type_id –∏—â–µ–º —Å—É–±—Ç–∏–ø –≤ `flower_subtypes` + `subtype_synonyms`
- –ü—Ä–∏–º–µ—Ä—ã: "–∫—É—Å—Ç–æ–≤–∞—è" ‚Üí "–ö—É—Å—Ç–æ–≤–∞—è", "—Å–ø—Ä–µ–π" ‚Üí "–°–ø—Ä–µ–π"

5) **Detect variety**
- –µ—Å–ª–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –ª–∞—Ç–∏–Ω—Å–∫–∏–µ —Ç–æ–∫–µ–Ω—ã (Explorer, Mondial, Pink Floyd‚Ä¶), –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö –∫–∞–∫ –ø–µ—Ä–≤–∏—á–Ω—É—é variety
- –∑–∞—Ç–µ–º –ø—Ä–æ–≥–æ–Ω—è–µ–º —á–µ—Ä–µ–∑ `flower_varieties` + `variety_synonyms` (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –∫–∞—Ç–∞–ª–æ–≥–µ)
- fallback –Ω–∞ `variety_alias` –∏–∑ dictionary_entries
- –µ—Å–ª–∏ variety –Ω–µ —É–≤–µ—Ä–µ–Ω–∞ ‚Üí –æ—Å—Ç–∞–≤–ª—è–µ–º NULL –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ manual-review (–µ—Å–ª–∏ product_type —Ç–æ–∂–µ –Ω–µ —É–≤–µ—Ä–µ–Ω)

6) **Candidate search –≤ normalized_skus**
–ú–µ—Ç–æ–¥—ã (–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É):
- Exact match: (product_type + variety) —Å–æ–≤–ø–∞–ª–∏ –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –≤–∏–¥—É
- High similarity (trgm): —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å title/variety
- Token overlap: –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ (–±–µ–∑ —Å—Ç–æ–ø-—Å–ª–æ–≤)

7) **Create/Update sku_mappings**
- —Å–æ–∑–¥–∞—ë–º 1..N –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (N<=5) –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
- –ª—É—á—à–∏–π –∫–∞–Ω–¥–∏–¥–∞—Ç –∏–¥—ë—Ç —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º confidence

---

## 6) Confidence scoring (–ø—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å MVP)

–¶–µ–ª—å: —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ —Ä–µ—à–∞—Ç—å, —á—Ç–æ —É—Ö–æ–¥–∏—Ç –≤ —Ä—É—á–Ω–æ–π —Ä–∞–∑–±–æ—Ä.

### 6.1 –ë–∞–∑–æ–≤—ã–π —Å–∫–æ—Ä
`score = 0.10`

### 6.2 –ü—Ä–∏–±–∞–≤–∫–∏
- product_type —Å–æ–≤–ø–∞–ª (–ø–æ —Å–ª–æ–≤–∞—Ä—é) ‚Üí `+0.30`
- variety exact (–ø–æ—Å–ª–µ alias) ‚Üí `+0.45`
- variety high similarity (trgm >= 0.70) ‚Üí `+0.30`
- subtype —Å–æ–≤–ø–∞–ª (spray/bush/standard/premium) ‚Üí `+0.05`
- country —Å–æ–≤–ø–∞–ª (–µ—Å–ª–∏ —É—á–∏—Ç—ã–≤–∞–µ–º) ‚Üí `+0.05`
- –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ —É–∂–µ –±—ã–ª confirmed mapping –¥–ª—è –ø–æ—Ö–æ–∂–µ–≥–æ stable_key (–µ—Å–ª–∏ –µ—Å—Ç—å) ‚Üí `+0.15`

### 6.3 –®—Ç—Ä–∞—Ñ—ã
- variety —Å–æ–¥–µ—Ä–∂–∏—Ç ‚Äú–º–∏–∫—Å/mix‚Äù ‚Üí `-0.25`
- name —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ / –º–∞–ª–æ —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí `-0.10`
- –∫–æ–Ω—Ñ–ª–∏–∫—Ç: –ø—Ä–æ–¥—É–∫—Ç-—Ç–∏–ø —Ä–æ–∑–∞, –Ω–æ —Ç–æ–∫–µ–Ω—ã –≥–≤–æ–∑–¥–∏–∫–∞ ‚Üí `-0.20`

### 6.4 –ü–æ—Ä–æ–≥–∏
- `score >= 0.90` ‚Üí –º–æ–∂–Ω–æ **auto-confirm (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ñ–ª–∞–≥–æ–º)**  
  (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å—ë —Ä–∞–≤–Ω–æ proposed, –Ω–æ —Å—Ç–∞–≤–∏–º high_priority_review=false)
- `0.70 <= score < 0.90` ‚Üí proposed ‚Üí –æ–±—ã—á–Ω—ã–π review
- `score < 0.70` ‚Üí —Å–æ–∑–¥–∞—ë–º `normalization_task` (manual –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

---

## 7) Manual-review (–æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á)

### 7.1 –ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞—ë–º normalization_task
- product_type –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω
- variety –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
- score < 0.70
- –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ —Å –±–ª–∏–∑–∫–∏–º–∏ score (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑–Ω–∏—Ü–∞ < 0.05)
- supplier_item –ø–æ–º–µ—á–µ–Ω ambiguous

### 7.2 –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (priority)
MVP-–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å—á–∏—Ç–∞–µ–º —Ç–∞–∫:
- base = 100
- + (–∫–æ–ª-–≤–æ offer_candidates –ø–æ supplier_item) * 2
- + 50 –µ—Å–ª–∏ supplier –≤–∞–∂–Ω—ã–π (—Ä—É—á–Ω–∞—è –º–µ—Ç–∫–∞ –≤ suppliers.meta: `tier=key`)
- + 20 –µ—Å–ª–∏ item –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–∞–π—Å–∞—Ö (stable_key –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è)
- - 30 –µ—Å–ª–∏ —ç—Ç–æ ‚Äú—Å–ª—É–∂–µ–±–Ω–æ–µ/–º—É—Å–æ—Ä‚Äù (stopwords/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏)

### 7.3 –≠–∫—Ä–∞–Ω –∞–¥–º–∏–Ω–∫–∏ ‚Äú–†–∞–∑–±–æ—Ä‚Äù
–î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º:
- raw_name, raw_group
- –ø—Ä–∏–º–µ—Ä—ã raw_rows (row_ref + raw_text)
- extracted attributes
- top-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö normalized_sku (title + score)
- –∫–Ω–æ–ø–∫–∏:
  - Confirm –≤—ã–±—Ä–∞–Ω–Ω—ã–π
  - Create new SKU
  - Edit dictionary (–≤ –º–æ–¥–∞–ª—å–Ω–æ–º)
  - Reject item (–µ—Å–ª–∏ –º—É—Å–æ—Ä)

### 7.4 –î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏
- sku_mappings.status ‚Üí confirmed
- sku_mappings.decided_at/by —Ñ–∏–∫—Å–∏—Ä—É–µ–º
- –∑–∞–ø—É—Å–∫–∞–µ–º republish –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ supplier (—Å–º. pipeline publish)

---

## 8) –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö SKU (Create SKU)

–ü—Ä–∞–≤–∏–ª–æ MVP:  
–ï—Å–ª–∏ variety —É–Ω–∏–∫–∞–ª—å–Ω–∞ –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –ª—É—á—à–µ —Å–æ–∑–¥–∞—Ç—å SKU.

### 8.1 –ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞—Ç—å SKU
- –ï—Å—Ç—å product_type + variety (–∏–ª–∏ subtype), –Ω–æ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- –≠—Ç–æ –Ω–µ ‚Äú–º–∏–∫—Å‚Äù
- –≠—Ç–æ –Ω–µ ‚Äú—Ä–∞–∑–æ–≤–æ–µ —Å–ª—É–∂–µ–±–Ω–æ–µ‚Äù

### 8.2 –ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å title
- `Rose Explorer`
- `Carnation Standard`
- `Alstroemeria Garda`
- `Greens Eucalyptus` (–µ—Å–ª–∏ –µ—Å—Ç—å)

meta –º–æ–∂–Ω–æ –Ω–∞–ø–æ–ª–Ω–∏—Ç—å:
- subtype/grade
- origin_default (–µ—Å–ª–∏ —Å—Ç—Ä–æ–≥–æ –ø–æ —Ä—ã–Ω–∫—É)

---

## 9) –ü—Ä–∏–º–µ—Ä—ã (–∏–∑ —Ç–∏–ø–æ–≤—ã—Ö –ø—Ä–∞–π—Å–æ–≤)

### –ü—Ä–∏–º–µ—Ä 1
`"–†–æ–∑–∞ Explorer 60—Å–º (–≠–∫–≤–∞–¥–æ—Ä)"`
- product_type=rose
- variety=Explorer
- origin=Ecuador (–≤ attributes)
- length_cm=60 (–≤ offer)
‚Üí mapping: Rose Explorer

### –ü—Ä–∏–º–µ—Ä 2 (–º–∞—Ç—Ä–∏—Ü–∞)
—Å—Ç—Ä–æ–∫–∞: `"–†–æ–∑–∞ —Å–ø—Ä–µ–π: Bombastic, ..."`
–∫–æ–ª–æ–Ω–∫–∏: `50 —Å–º –±–∞–∫`, `50 —Å–º —É–ø–∞–∫`, `60 —Å–º –±–∞–∫`...
- supplier_item = ‚Äú–†–æ–∑–∞ —Å–ø—Ä–µ–π Bombastic ‚Ä¶‚Äù (SAFE MODE: –ø–æ–∫–∞ bundle)
- offer_candidates = N —Å—Ç—Ä–æ–∫ –ø–æ (length_cm, pack_type)
‚Üí manual-review: –ª–∏–±–æ —Ä–∞–∑–Ω–µ—Å—Ç–∏ –Ω–∞ —Å–æ—Ä—Ç–∞, –ª–∏–±–æ —Å–æ–∑–¥–∞—Ç—å bundle SKU ‚ÄúSpray Roses Mix‚Äù (–µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ —Ç–∞–∫ –ø—Ä–æ–¥–∞—ë—Ç—Å—è)

### –ü—Ä–∏–º–µ—Ä 3 (—Ç–∏—Ä—ã)
`"–†–æ–∑–∞ ..."` + —Ü–µ–Ω—ã –ø–æ ‚Äú–æ—Ç 100 –¥–æ 200‚Äù
- offer_candidates: –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ —Å tier_min_qty/max_qty
- SKU –º–∞–ø–ø–∏—Ç—Å—è 1 —Ä–∞–∑, –æ—Ñ—Ñ–µ—Ä—ã –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –ø–∞—á–∫–æ–π

---

## 10) –ü–µ—Ä–µ–ø—É–±–ª–∏–∫–∞—Ü–∏—è –∏ ‚Äú—ç—Ñ—Ñ–µ–∫—Ç —Å–ª–æ–≤–∞—Ä—è‚Äù

–ö–æ–≥–¥–∞:
- –æ–±–Ω–æ–≤–∏–ª–∏ dictionary_entries
- –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ sku_mappings
- –ø–æ–ø—Ä–∞–≤–∏–ª–∏ supplier_item.attributes

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ:
- –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å propose –¥–ª—è open tasks
- –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å offers (publish stage) –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ raw import

---

## 11) –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä —Å–ª–æ–≤–∞—Ä–µ–π –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ (bootstrap checklist)

1) product_type: —Ä–æ–∑–∞, –≥–≤–æ–∑–¥–∏–∫–∞, –∞–ª—å—Å—Ç—Ä–æ–º–µ—Ä–∏—è, —Ö—Ä–∏–∑–∞–Ω—Ç–µ–º–∞, –∑–µ–ª–µ–Ω—å, —É–ø–∞–∫–æ–≤–∫–∞
2) country: –≠–∫–≤–∞–¥–æ—Ä, –ö–æ–ª—É–º–±–∏—è, –ì–æ–ª–ª–∞–Ω–¥–∏—è/–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã, –ö–µ–Ω–∏—è, –ò–∑—Ä–∞–∏–ª—å
3) pack_type: –±–∞–∫, —É–ø–∞–∫
4) stopwords: –∏–º–ø–æ—Ä—Ç, —Å–æ—Ä—Ç–æ–≤—ã–µ, —Ä—É–±/—Ä/‚ÇΩ, —Å–º/cm, —Ü–µ–Ω–∞, –ø—Ä–∞–π—Å, –ª–∏—Å—Ç
5) regex_rule: –¥–ª–∏–Ω–∞, —Å—Ç—Ä–∞–Ω–∞, pack_qty, subtype/grade

---

## 12) –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ (Implementation Reference)

### 12.1 –ú–æ–¥—É–ª–∏

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `packages/core/normalization/`:

| –ú–æ–¥—É–ª—å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|--------|------------|
| `tokens.py` | –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ |
| `detection.py` | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ product_type, variety, subtype |
| `confidence.py` | –†–∞—Å—á—ë—Ç confidence score |

### 12.2 –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è (tokens.py)

#### normalize_tokens(text: str) ‚Üí str

```python
def normalize_tokens(text: str) -> str:
    """
    –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è matching.

    –®–∞–≥–∏:
    1. Lowercase
    2. Trim
    3. –£–¥–∞–ª–∏—Ç—å –≤–∞–ª—é—Ç–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (‚ÇΩ$‚Ç¨)
    4. –ó–∞–º–µ–Ω–∏—Ç—å em/en dash –Ω–∞ hyphen
    5. –£–¥–∞–ª–∏—Ç—å —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã (–æ—Å—Ç–∞–≤–∏—Ç—å –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã)
    6. –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã
    """
    normalized = text.lower().strip()
    normalized = re.sub(r"[‚ÇΩ$‚Ç¨]", "", normalized)
    normalized = normalized.replace("‚Äì", "-").replace("‚Äî", "-")
    normalized = re.sub(r"[^\w\s\-()]", " ", normalized, flags=re.UNICODE)
    normalized = re.sub(r"\s+", " ", normalized).strip()
    return normalized
```

**–ü—Ä–∏–º–µ—Ä:**
```
Input:  "–†–æ–∑–∞ Explorer 60—Å–º  (–≠–∫–≤–∞–¥–æ—Ä) ‚Äî 120‚ÇΩ"
Output: "—Ä–æ–∑–∞ explorer 60—Å–º (—ç–∫–≤–∞–¥–æ—Ä) - 120"
```

#### extract_latin_tokens(text: str) ‚Üí List[str]

```python
def extract_latin_tokens(text: str) -> List[str]:
    """
    –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ª–∞—Ç–∏–Ω—Å–∫–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤ (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å–æ—Ä—Ç–æ–≤).

    Pattern: Capitalized Latin words
    """
    pattern = r"\b[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*\b"
    return re.findall(pattern, text)
```

**–ü—Ä–∏–º–µ—Ä:**
```
Input:  "–†–æ–∑–∞ Explorer Pink Floyd 60—Å–º"
Output: ["Explorer", "Pink Floyd"]
```

### 12.3 Detection (detection.py)

#### detect_product_type(text, product_type_dict) ‚Üí Optional[str]

```python
def detect_product_type(text: str, product_type_dict: dict) -> Optional[str]:
    """
    –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ –ø–æ —Å–ª–æ–≤–∞—Ä—é.

    –ê–ª–≥–æ—Ä–∏—Ç–º:
    1. –î–ª—è –∫–∞–∂–¥–æ–≥–æ product_type –≤ —Å–ª–æ–≤–∞—Ä–µ
    2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å value –∏ –≤—Å–µ synonyms
    3. –í–µ—Ä–Ω—É—Ç—å –ø–µ—Ä–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    """
    text_lower = text.lower()

    for key, entry in product_type_dict.items():
        value = entry.get("value", key)
        synonyms = entry.get("synonyms", [])

        if value.lower() in text_lower:
            return value

        for synonym in synonyms:
            if synonym.lower() in text_lower:
                return value

    return None
```

**–ü—Ä–∏–º–µ—Ä —Å–ª–æ–≤–∞—Ä—è:**
```python
product_type_dict = {
    "—Ä–æ–∑–∞": {
        "value": "rose",
        "synonyms": ["rose", "—Ä–æ–∑—ã", "roses", "—Ä–æ–∑–∞ —Å–ø—Ä–µ–π", "–∫—É—Å—Ç–æ–≤–∞—è —Ä–æ–∑–∞"]
    },
    "–≥–≤–æ–∑–¥–∏–∫–∞": {
        "value": "carnation",
        "synonyms": ["carnation", "–≥–≤–æ–∑–¥–∏–∫–∏", "dianthus"]
    }
}
```

#### detect_variety(raw_name, variety_alias_dict) ‚Üí Optional[str]

```python
def detect_variety(raw_name: str, variety_alias_dict: dict = None) -> Optional[str]:
    """
    –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∞.

    –ê–ª–≥–æ—Ä–∏—Ç–º:
    1. –ò–∑–≤–ª–µ—á—å –ª–∞—Ç–∏–Ω—Å–∫–∏–µ —Ç–æ–∫–µ–Ω—ã
    2. –ï—Å–ª–∏ –µ—Å—Ç—å variety_alias_dict - –ø–æ–∏—Å–∫ –ø–æ –∞–ª–∏–∞—Å–∞–º
    3. –ò–Ω–∞—á–µ –≤–µ—Ä–Ω—É—Ç—å –ø–µ—Ä–≤—ã–π –ª–∞—Ç–∏–Ω—Å–∫–∏–π —Ç–æ–∫–µ–Ω
    """
    latin_tokens = extract_latin_tokens(raw_name)

    if not latin_tokens:
        return None

    # –ü–æ–∏—Å–∫ –ø–æ –∞–ª–∏–∞—Å–∞–º
    if variety_alias_dict:
        for token in latin_tokens:
            for key, entry in variety_alias_dict.items():
                if token.lower() == key.lower():
                    return entry.get("value", key)
                for synonym in entry.get("synonyms", []):
                    if token.lower() == synonym.lower():
                        return entry.get("value", key)

    return latin_tokens[0]
```

#### detect_subtype(text, regex_rules) ‚Üí Optional[str]

```python
def detect_subtype(text: str, regex_rules: list) -> Optional[str]:
    """
    –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–¥—Ç–∏–ø–∞ –ø–æ regex –ø—Ä–∞–≤–∏–ª–∞–º.

    –ü—Ä–∞–≤–∏–ª–∞ –∑–∞–¥–∞—é—Ç—Å—è –≤ —Å–ª–æ–≤–∞—Ä–µ dict_type=regex_rule.
    """
    for rule in regex_rules:
        pattern = rule.get("pattern")
        result = rule.get("result")

        if re.search(pattern, text, re.IGNORECASE):
            return result

    return None
```

**–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª:**
```python
regex_rules = [
    {"pattern": r"\b—Å–ø—Ä–µ–π\b|\bspray\b", "result": "spray"},
    {"pattern": r"\b–∫—É—Å—Ç–æ–≤–∞—è\b|\bbush\b", "result": "bush"},
    {"pattern": r"\b—Å—Ç–∞–Ω–¥–∞—Ä—Ç\b|\bstandard\b", "result": "standard"},
    {"pattern": r"\b–ø—Ä–µ–º–∏—É–º\b|\bpremium\b", "result": "premium"},
]
```

### 12.4 Confidence Scoring (confidence.py)

#### –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á—ë—Ç–∞ confidence

```
confidence = BASE + Œ£(positive_signals) - Œ£(penalties)
confidence = clamp(confidence, 0.0, 1.0)
```

#### –¢–∞–±–ª–∏—Ü–∞ –≤–µ—Å–æ–≤

| –°–∏–≥–Ω–∞–ª | –í–µ—Å | –£—Å–ª–æ–≤–∏–µ |
|--------|-----|---------|
| **Base** | +0.10 | –í—Å–µ–≥–¥–∞ |
| **product_type_match** | +0.30 | –¢–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞ –Ω–∞–π–¥–µ–Ω –≤ —Å–ª–æ–≤–∞—Ä–µ |
| **variety_exact** | +0.45 | –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å–æ—Ä—Ç–∞ |
| **variety_high** | +0.30 | –í—ã—Å–æ–∫–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ (‚â•70% overlap –∏–ª–∏ inclusion) |
| **variety_low** | +0.10 | –ù–∏–∑–∫–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ (40-70% overlap) |
| **subtype_match** | +0.05 | –ü–æ–¥—Ç–∏–ø —Å–æ–≤–ø–∞–ª (spray/bush/etc) |
| **country_match** | +0.05 | –°—Ç—Ä–∞–Ω–∞ —Å–æ–≤–ø–∞–ª–∞ |
| **has_mix_keyword** | -0.25 | –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–º–∏–∫—Å/mix" |
| **name_too_short** | -0.10 | –ú–µ–Ω—å—à–µ 3 —Ç–æ–∫–µ–Ω–æ–≤ |
| **conflicting_type** | -0.20 | –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã —Ç–∏–ø–∞ |

#### calculate_confidence() ‚Äî –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

```python
def calculate_confidence(
    product_type_match: bool = False,
    variety_match: str = None,   # "exact" | "high" | "low" | None
    subtype_match: bool = False,
    country_match: bool = False,
    has_mix_keyword: bool = False,
    name_too_short: bool = False,
    conflicting_product_type: bool = False,
) -> Decimal:
    """
    –†–∞—Å—á—ë—Ç confidence score –¥–ª—è SKU mapping.
    """
    score = Decimal("0.10")  # Base

    # Positive signals
    if product_type_match:
        score += Decimal("0.30")

    if variety_match == "exact":
        score += Decimal("0.45")
    elif variety_match == "high":
        score += Decimal("0.30")
    elif variety_match == "low":
        score += Decimal("0.10")

    if subtype_match:
        score += Decimal("0.05")

    if country_match:
        score += Decimal("0.05")

    # Penalties
    if has_mix_keyword:
        score -= Decimal("0.25")

    if name_too_short:
        score -= Decimal("0.10")

    if conflicting_product_type:
        score -= Decimal("0.20")

    # Clamp [0.0, 1.0]
    return max(Decimal("0"), min(Decimal("1"), score))
```

#### variety_similarity(v1, v2) ‚Üí str

```python
def variety_similarity(variety1: str, variety2: str) -> str:
    """
    –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å—Ö–æ–¥—Å—Ç–≤–∞ —Å–æ—Ä—Ç–æ–≤.

    Returns: "exact" | "high" | "low" | "none"
    """
    v1, v2 = variety1.lower(), variety2.lower()

    # Exact match
    if v1 == v2:
        return "exact"

    # One contains the other
    if v1 in v2 or v2 in v1:
        return "high"

    # Token overlap
    tokens1, tokens2 = set(v1.split()), set(v2.split())
    overlap = len(tokens1 & tokens2)
    total = len(tokens1 | tokens2)
    similarity = overlap / total if total > 0 else 0.0

    if similarity >= 0.7:
        return "high"
    elif similarity >= 0.4:
        return "low"
    else:
        return "none"
```

### 12.5 –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á—ë—Ç–∞ confidence

#### –ü—Ä–∏–º–µ—Ä 1: –í—ã—Å–æ–∫–∏–π confidence

```
raw_name: "–†–æ–∑–∞ Explorer 60—Å–º (–≠–∫–≤–∞–¥–æ—Ä)"

–°–∏–≥–Ω–∞–ª—ã:
- product_type_match = True (—Ä–æ–∑–∞ ‚Üí rose)     +0.30
- variety_match = "exact" (Explorer)          +0.45
- country_match = True (–≠–∫–≤–∞–¥–æ—Ä)              +0.05
- Base                                        +0.10
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total: 0.90 (HIGH - auto-confirm candidate)
```

#### –ü—Ä–∏–º–µ—Ä 2: –°—Ä–µ–¥–Ω–∏–π confidence

```
raw_name: "–†–æ–∑–∞ –∫—Ä–∞—Å–Ω–∞—è 50—Å–º"

–°–∏–≥–Ω–∞–ª—ã:
- product_type_match = True                   +0.30
- variety_match = None                         0.00
- Base                                        +0.10
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total: 0.40 (LOW - manual review required)
```

#### –ü—Ä–∏–º–µ—Ä 3: –ù–∏–∑–∫–∏–π confidence —Å penalty

```
raw_name: "–ú–∏–∫—Å —Ä–æ–∑"

–°–∏–≥–Ω–∞–ª—ã:
- product_type_match = True                   +0.30
- has_mix_keyword = True                      -0.25
- name_too_short = True                       -0.10
- Base                                        +0.10
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total: 0.05 (VERY LOW - likely bundle/mix)
```

### 12.6 –ü–æ–ª–Ω—ã–π flow –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    NormalizationService.propose()                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                         ‚îÇ
‚îÇ  INPUT: SupplierItem (raw_name, raw_group, attributes)                 ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ 1. TOKENIZE                                                      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    name_norm = normalize_tokens(raw_name + " " + raw_group)     ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚îÇ                                          ‚îÇ
‚îÇ                              ‚ñº                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ 2. DETECT ATTRIBUTES                                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    product_type = detect_product_type(name_norm, dict)          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    variety = detect_variety(raw_name, aliases)                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    subtype = detect_subtype(name_norm, regex_rules)             ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚îÇ                                          ‚îÇ
‚îÇ                              ‚ñº                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ 3. SEARCH CANDIDATE SKUs                                         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    - Exact match by (product_type, variety)                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    - High similarity by title/variety                           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    - Token overlap scoring                                       ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚îÇ                                          ‚îÇ
‚îÇ                              ‚ñº                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ 4. CALCULATE CONFIDENCE                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    FOR EACH candidate:                                           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ      score = calculate_confidence(                               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ        product_type_match,                                       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ        variety_similarity(item.variety, sku.variety),           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ        subtype_match,                                            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ        ...                                                       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ      )                                                           ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚îÇ                                          ‚îÇ
‚îÇ                              ‚ñº                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ 5. CREATE SKU MAPPINGS                                           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    - Top 5 candidates —Å confidence > 0.10                       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    - status = "proposed"                                         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚îÇ                                          ‚îÇ
‚îÇ                              ‚ñº                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ 6. CREATE TASK IF NEEDED                                         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    IF best_confidence < 0.70:                                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ      CREATE NormalizationTask(status=open, reason="low conf")   ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  OUTPUT: List[SKUMapping], Optional[NormalizationTask]                 ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 13) AI –û–±–æ–≥–∞—â–µ–Ω–∏–µ (AI Enrichment)

### 13.1 –û–±–∑–æ—Ä

–ü–æ—Å–ª–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AI (DeepSeek API) –¥–ª—è:
- –ò–∑–≤–ª–µ—á–µ–Ω–∏—è –∞—Ç—Ä–∏–±—É—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–∞—Ä—Å–µ—Ä –Ω–µ —Å–º–æ–≥ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
- –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ `clean_name` ‚Äî —á–∏—Å—Ç–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –≤–∏—Ç—Ä–∏–Ω—ã
- –í–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### 13.2 –ò–∑–≤–ª–µ–∫–∞–µ–º—ã–µ –ø–æ–ª—è

AI –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã –∏–∑ `raw_name`:

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------|----------|--------|
| `flower_type` | –¢–∏–ø —Ü–≤–µ—Ç–∫–∞ | –†–æ–∑–∞, –•—Ä–∏–∑–∞–Ω—Ç–µ–º–∞ |
| `subtype` | –°—É–±—Ç–∏–ø (–∫—É—Å—Ç–æ–≤–∞—è, —Å–ø—Ä–µ–π) | –∫—É—Å—Ç–æ–≤–∞—è, —Å–ø—Ä–µ–π |
| `variety` | –°–æ—Ä—Ç | Explorer, Lydia |
| `origin_country` | –°—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è | –≠–∫–≤–∞–¥–æ—Ä |
| `length_cm` | –î–ª–∏–Ω–∞ —Å—Ç–µ–±–ª—è | 50 |
| `colors` | –¶–≤–µ—Ç–∞ (–º–∞—Å—Å–∏–≤) | ["–∫—Ä–∞—Å–Ω—ã–π"] |
| `farm` | –§–µ—Ä–º–∞/–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å | FRAMA FLOWERS |
| `clean_name` | **–ß–∏—Å—Ç–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤–∏—Ç—Ä–∏–Ω—ã** | –†–æ–∑–∞ –∫—É—Å—Ç–æ–≤–∞—è Lydia |

### 13.3 –§–æ—Ä–º–∞—Ç clean_name

**–§–æ—Ä–º–∞—Ç:** `{–¢–∏–ø} {—Å—É–±—Ç–∏–ø} {–°–æ—Ä—Ç}`

**–ü—Ä–∞–≤–∏–ª–∞:**
- –°—É–±—Ç–∏–ø –ø–∏—à–µ—Ç—Å—è –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
- –°–æ—Ä—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–≥–∏—Å—Ç—Ä
- –ù–µ –≤–∫–ª—é—á–∞—é—Ç—Å—è: –¥–ª–∏–Ω–∞, —Å—Ç—Ä–∞–Ω–∞, —Ü–µ–Ω–∞, —Ñ–µ—Ä–º–∞, —Ü–≤–µ—Ç

**–ü—Ä–∏–º–µ—Ä—ã:**
| raw_name | clean_name |
|----------|------------|
| –†–æ–∑–∞ Explorer 50—Å–º (–≠–∫–≤–∞–¥–æ—Ä) FRAMA | –†–æ–∑–∞ Explorer |
| –†–æ–∑–∞ –∫—É—Å—Ç–æ–≤–∞—è Lydia –∫—Ä–∞—Å–Ω–∞—è 40—Å–º | –†–æ–∑–∞ –∫—É—Å—Ç–æ–≤–∞—è Lydia |
| –•—Ä–∏–∑–∞–Ω—Ç–µ–º–∞ –ë–∞–ª—Ç–∏–∫–∞ –±–µ–ª–∞—è –ì–æ–ª–ª–∞–Ω–¥–∏—è | –•—Ä–∏–∑–∞–Ω—Ç–µ–º–∞ –ë–∞–ª—Ç–∏–∫–∞ |
| –ì–≤–æ–∑–¥–∏–∫–∞ —Å–ø—Ä–µ–π –º–∏–∫—Å 60 | –ì–≤–æ–∑–¥–∏–∫–∞ —Å–ø—Ä–µ–π |

### 13.4 Confidence –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

AI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç confidence –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è:

| Confidence | –°—Ç–∞—Ç—É—Å | –î–µ–π—Å—Ç–≤–∏–µ |
|------------|--------|----------|
| >= 0.90 | AUTO_APPLIED | –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |
| 0.70-0.89 | APPLIED_WITH_MARK | –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è, –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ AI |
| < 0.70 | NEEDS_REVIEW | –í –æ—á–µ—Ä–µ–¥—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É |

### 13.5 –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞

AI –ø—Ä–æ–º–ø—Ç –ø–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î:
- `flower_types` ‚Äî —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ü–≤–µ—Ç–æ–≤
- `flower_subtypes` ‚Äî —Å—É–±—Ç–∏–ø—ã —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ —Ç–∏–ø–∞–º
- Fallback –Ω–∞ hardcoded —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –µ—Å–ª–∏ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

**–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** TTL = 5 –º–∏–Ω—É—Ç

### 13.6 –•—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

AI-–∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `supplier_items.attributes`:

```json
{
  "flower_type": "–†–æ–∑–∞",
  "subtype": "–∫—É—Å—Ç–æ–≤–∞—è",
  "variety": "Lydia",
  "clean_name": "–†–æ–∑–∞ –∫—É—Å—Ç–æ–≤–∞—è Lydia",
  "_sources": {
    "flower_type": "ai",
    "subtype": "ai",
    "variety": "ai",
    "clean_name": "ai"
  },
  "_confidences": {
    "flower_type": 0.98,
    "subtype": 0.95,
    "variety": 0.92,
    "clean_name": 0.96
  }
}
```

### 13.7 –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å clean_name

–ü—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ—Ñ—Ñ–µ—Ä–æ–≤ (`publish_service`):
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è `clean_name` –∏–∑ `supplier_item.attributes`
2. –ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∏–∑ `flower_type + subtype + variety`
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `offers.display_title`

**API –æ—Ç–≤–µ—Ç:**
```json
{
  "offers": [{
    "display_title": "–†–æ–∑–∞ –∫—É—Å—Ç–æ–≤–∞—è Lydia",
    "length_cm": 50,
    "price_min": 120,
    "sku": {"product_type": "–†–æ–∑–∞", "variety": "Lydia"}
  }]
}
```

### 13.8 AI Column Mapping (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫)

–ö–æ–≥–¥–∞ keyword-based `normalize_headers()` –Ω–µ –º–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É `price` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ), —Å–∏—Å—Ç–µ–º–∞ –≤—ã–∑—ã–≤–∞–µ—Ç AI –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–∞–ø–ø–∏–Ω–≥–∞.

**–ú–æ–¥—É–ª—å:** `packages/core/ai/column_mapping.py`

**–í—Ö–æ–¥:**
- `headers` ‚Äî —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞
- `sample_rows` ‚Äî –ø–µ—Ä–≤—ã–µ 3‚Äì5 —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö

**AI-–æ—Ç–≤–µ—Ç:**
```json
{
  "column_mapping": [
    {"source_index": 0, "target_field": "raw_name", "confidence": 0.95},
    {"source_index": 1, "target_field": "price", "confidence": 0.90},
    {"source_index": 2, "target_field": "pack_qty", "confidence": 0.85}
  ]
}
```

**–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:**
- –ü—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –º–∞–ø–ø–∏–Ω–≥–∏ —Å `confidence >= 0.60`
- `source_index` –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö `[0, len(headers))`)
- `raw_name` ‚Üí `name` –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å `normalize_headers()`

**–ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ `ImportService`, –µ—Å–ª–∏ keyword-matching –≤–µ—Ä–Ω—É–ª –º–∞–ø–ø–∏–Ω–≥ –±–µ–∑ `price`.

### 13.9 AI Text Extraction (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ PDF)

–ö–æ–≥–¥–∞ pdfplumber –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Ç–∞–±–ª–∏—Ü –≤ PDF (–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø—Ä–∞–π—Å—ã), —Å–∏—Å—Ç–µ–º–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ AI.

**–ú–æ–¥—É–ª—å:** `packages/core/ai/text_extraction.py`

**–í—Ö–æ–¥:** —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç –∏–∑ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü PDF (–∏–∑–≤–ª–µ—á—ë–Ω —á–µ—Ä–µ–∑ PyMuPDF/fitz)

**AI-–æ—Ç–≤–µ—Ç:**
```json
{
  "document_type": "commercial_offer",
  "items": [
    {"name": "–¢—é–ª—å–ø–∞–Ω—ã (–∂—ë–ª—Ç—ã–µ, —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ, —Ä–æ–∑–æ–≤—ã–µ)", "price": 75, "unit": "—à—Ç", "pack_qty": 50}
  ],
  "notes": "–ö–ü –Ω–∞ —Ç—é–ª—å–ø–∞–Ω—ã"
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** AI-–æ—Ç–≤–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–∫ `[{"row_number": N, "cells": [name, unit, price], "headers": [...]}]` –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –æ–±—ã—á–Ω—ã–π `_process_rows()`.

**–ü—Ä–∏–º–µ—Ä:** –ö–ü "–¢—é–ª—å–ø–∞–Ω—ã (–∂—ë–ª—Ç—ã–µ, —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ, —Ä–æ–∑–æ–≤—ã–µ)" ‚Üí AI –∏–∑–≤–ª–µ–∫–∞–µ—Ç 1 –ø–æ–∑–∏—Ü–∏—é ‚Üí bundle expansion —Ä–∞–∑–±–∏–≤–∞–µ—Ç –Ω–∞ 7 —Å–æ—Ä—Ç–æ–≤ ‚Üí 7 `supplier_items`.

---

## 14) –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [ARCHITECTURE.md](ARCHITECTURE.md) ‚Äî –æ–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- [WORKFLOWS.md](WORKFLOWS.md) ‚Äî –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã
- [DATA_LIFECYCLE.md](DATA_LIFECYCLE.md) ‚Äî –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –¥–∞–Ω–Ω—ã—Ö
- [ADMIN_API.md](ADMIN_API.md) ‚Äî API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [IMPORT_PIPELINE.md](IMPORT_PIPELINE.md) ‚Äî –ø–∞–π–ø–ª–∞–π–Ω –∏–º–ø–æ—Ä—Ç–∞
- [DDL_SCHEMA.md](DDL_SCHEMA.md) ‚Äî —Å—Ö–µ–º–∞ –ë–î