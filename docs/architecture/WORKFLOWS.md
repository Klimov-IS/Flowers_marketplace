# WORKFLOWS.md — Бизнес-процессы B2B Flower Market Platform

## Обзор

Этот документ описывает все end-to-end бизнес-процессы платформы: от регистрации поставщика до выполнения заказа.

---

## 1. Регистрация и онбординг поставщика

### 1.1 Диаграмма процесса

```
┌─────────────┐    ┌──────────────┐    ┌─────────────────┐    ┌──────────────┐
│   Админ     │───▶│  Создаёт     │───▶│   Supplier      │───▶│  Готов к     │
│   платформы │    │  поставщика  │    │   создан        │    │  импорту     │
└─────────────┘    └──────────────┘    └─────────────────┘    └──────────────┘
```

### 1.2 Шаги

| Шаг | Действие | Endpoint | Результат |
|-----|----------|----------|-----------|
| 1 | Админ создаёт поставщика | `POST /admin/suppliers` | Supplier(status=active) |
| 2 | Заполняет контактные данные | — | name, contact_email, city_id |
| 3 | Поставщик готов к импорту | — | Может загружать прайсы |

### 1.3 Данные поставщика

```json
{
  "name": "Росцветторг",
  "contact_email": "info@roscvettorg.ru",
  "city_id": "uuid-moscow",
  "is_active": true
}
```

---

## 2. Импорт CSV прайс-листа

### 2.1 Happy Path

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  Загрузка    │───▶│  Сохранение  │───▶│   Парсинг    │───▶│   Создание   │
│  CSV файла   │    │  RAW данных  │    │   строк      │    │  candidates  │
└──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
  ImportBatch         RawRows            SupplierItems      OfferCandidates
  (received)        (immutable)         (stable_key)         (parsed)
```

### 2.2 Детальный flow

```
POST /admin/suppliers/{id}/imports/csv
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        ImportService.import_csv()                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. Валидация файла                                               │   │
│  │    - Проверка размера (max 10MB)                                 │   │
│  │    - Проверка MIME type (text/csv, application/octet-stream)    │   │
│  │    - Определение кодировки (UTF-8, CP1251, CP866)               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 2. Создание ImportBatch                                          │   │
│  │    - status = "received"                                         │   │
│  │    - file_name, file_size                                        │   │
│  │    - supplier_id                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 3. Парсинг CSV [packages/core/parsing]                          │   │
│  │    - parse_csv_content() → List[dict]                           │   │
│  │    - detect_header_row() → находит строку с заголовками         │   │
│  │    - normalize_headers() → name, price, qty mapping             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 4. Сохранение RawRows (IMMUTABLE)                               │   │
│  │    - Каждая строка CSV → RawRow                                 │   │
│  │    - row_number, cells (JSON), headers                          │   │
│  │    - НИКОГДА не модифицируются                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 5. Извлечение атрибутов [packages/core/parsing]                 │   │
│  │    - parse_price() → price_min, price_max                       │   │
│  │    - extract_length_cm() → 40, 50, 60...                        │   │
│  │    - extract_pack_qty() → 10, 20, 25...                         │   │
│  │    - extract_country() → "Эквадор", "Голландия"...              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 6. Создание SupplierItem                                         │   │
│  │    - generate_stable_key() для дедупликации                     │   │
│  │    - UPSERT по stable_key                                        │   │
│  │    - raw_name, parsed_attributes                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 7. Создание OfferCandidate                                       │   │
│  │    - Связь с SupplierItem и ImportBatch                         │   │
│  │    - price_min, price_max, qty_available                        │   │
│  │    - status = "pending"                                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 8. Логирование ParseRun + ParseEvents                           │   │
│  │    - Записать все warnings/errors                               │   │
│  │    - Статистика: rows_total, rows_parsed, rows_failed           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│                   ImportBatch.status = "parsed"                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.3 Error Path

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  Загрузка    │───▶│   Ошибка     │───▶│   Batch      │
│  CSV файла   │    │   парсинга   │    │   failed     │
└──────────────┘    └──────────────┘    └──────────────┘
                           │
                           ▼
                    ParseEvent(error)
```

**Типичные ошибки:**

| Ошибка | Причина | Действие |
|--------|---------|----------|
| `encoding_error` | Неизвестная кодировка | Попробовать другую кодировку |
| `no_headers` | Не найдены заголовки | Проверить формат файла |
| `price_parse_error` | Невалидная цена | Логировать, пропустить строку |
| `empty_name` | Пустое название | Пропустить строку |

---

## 3. Нормализация (Propose Flow)

### 3.1 Диаграмма

```
┌───────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│ SupplierItem  │───▶│   Dictionary  │───▶│  NormalizedSKU│───▶│  SKUMapping   │
│ (raw_name)    │    │   lookup      │    │  (canonical)  │    │  (proposed)   │
└───────────────┘    └───────────────┘    └───────────────┘    └───────────────┘
                                                                      │
                                                                      ▼
                                                               confidence < 0.7?
                                                                      │
                                                    ┌─────────────────┴─────────────────┐
                                                    ▼                                   ▼
                                          NormalizationTask               Auto-confirm (high conf)
                                          (manual_review)
```

### 3.2 Алгоритм нормализации

```
POST /admin/normalization/propose?batch_id={uuid}
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                   NormalizationService.propose()                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  FOR EACH OfferCandidate WHERE status = "pending":                      │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. Токенизация raw_name                                          │   │
│  │    - Разбить на слова                                           │   │
│  │    - Удалить стоп-слова ("цветы", "шт", "упак")                 │   │
│  │    - Нормализовать регистр                                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 2. Поиск в Dictionary                                            │   │
│  │    - detect_product_type() → "rose", "chrysanthemum"...         │   │
│  │    - detect_variety() → "Freedom", "Explorer"...                │   │
│  │    - detect_subtype() → "spray", "standard"...                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 3. Найти или создать NormalizedSKU                              │   │
│  │    - Lookup по (product_type, variety, subtype, length_cm)     │   │
│  │    - Если не найден → создать новый                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 4. Расчёт confidence score                                       │   │
│  │    - product_type найден? +0.3                                  │   │
│  │    - variety найден? +0.3                                       │   │
│  │    - length_cm извлечён? +0.2                                   │   │
│  │    - country извлечён? +0.2                                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 5. Создать SKUMapping                                            │   │
│  │    - supplier_item_id → normalized_sku_id                       │   │
│  │    - confidence_score                                            │   │
│  │    - status = "proposed"                                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 6. Если confidence < 0.7:                                        │   │
│  │    - Создать NormalizationTask                                   │   │
│  │    - task_type = "ambiguous_mapping"                            │   │
│  │    - priority = (1.0 - confidence)                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Confidence Thresholds

| Уровень | Score | Действие |
|---------|-------|----------|
| High | ≥ 0.9 | Auto-confirm (если включено) |
| Medium | 0.7-0.9 | Proposed, ждёт review |
| Low | < 0.7 | NormalizationTask создан |

---

## 4. Ручной review (Manual Review Flow)

### 4.1 Диаграмма

```
┌───────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│ Normalization │───▶│  Оператор     │───▶│   Выбирает    │───▶│  Mapping      │
│ Task (pending)│    │  просматривает│    │   правильный  │    │  confirmed    │
└───────────────┘    └───────────────┘    │   SKU         │    └───────────────┘
                                          └───────────────┘
                                                 │
                                                 ▼
                                          Может создать
                                          новый SKU
```

### 4.2 Шаги

```
GET /admin/normalization/tasks?status=pending
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ Список задач на review:                                                  │
│                                                                         │
│ ┌─────────────────────────────────────────────────────────────────┐    │
│ │ Task #1                                                          │    │
│ │ Raw: "Роза Фридом эквадор 60 см"                                │    │
│ │ Proposed SKU: Rose / Freedom / standard / 60cm                   │    │
│ │ Confidence: 0.65                                                 │    │
│ │ [Confirm] [Edit SKU] [Create New SKU] [Skip]                    │    │
│ └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
         │
         ▼ (Оператор выбирает действие)
         │
┌────────┴────────┬─────────────────┬─────────────────┐
│                 │                 │                 │
▼                 ▼                 ▼                 ▼
[Confirm]    [Edit SKU]      [Create New]        [Skip]
    │             │                 │                │
    ▼             ▼                 ▼                ▼
POST /confirm  POST /update   POST /skus      (no action)
    │             │                 │
    └─────────────┴─────────────────┘
                  │
                  ▼
         SKUMapping.status = "confirmed"
         NormalizationTask.status = "resolved"
```

### 4.3 Endpoints

| Действие | Endpoint | Payload |
|----------|----------|---------|
| Confirm mapping | `POST /admin/normalization/confirm` | `{mapping_id}` |
| Edit mapping | `PUT /admin/sku-mappings/{id}` | `{normalized_sku_id}` |
| Create SKU | `POST /admin/skus` | `{product_type, variety, ...}` |
| Resolve task | `PUT /admin/normalization/tasks/{id}` | `{status: "resolved"}` |

---

## 5. Публикация офферов (Publish Flow)

### 5.1 Диаграмма

```
┌───────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│ ImportBatch   │───▶│ Confirmed     │───▶│ Deactivate    │───▶│ Create new    │
│ (parsed)      │    │ mappings only │    │ old offers    │    │ Offers        │
└───────────────┘    └───────────────┘    └───────────────┘    └───────────────┘
```

### 5.2 Алгоритм публикации

```
POST /admin/publish/suppliers/{supplier_id}
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    PublishService.publish_offers()                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. Найти latest ImportBatch для supplier                        │   │
│  │    WHERE status = "parsed"                                       │   │
│  │    ORDER BY created_at DESC                                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 2. Получить offer_candidates для этого batch                     │   │
│  │    WHERE status = "pending" OR status = "processed"              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 3. JOIN с sku_mappings WHERE status = "confirmed"               │   │
│  │    (только подтверждённые маппинги публикуются!)                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 4. Деактивировать старые offers этого поставщика                │   │
│  │    UPDATE offers SET is_active = false                          │   │
│  │    WHERE supplier_id = ? AND is_active = true                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 5. Создать новые Offers                                          │   │
│  │    FOR EACH (candidate + confirmed_mapping):                     │   │
│  │      - normalized_sku_id                                         │   │
│  │      - supplier_id                                               │   │
│  │      - price_min, price_max                                      │   │
│  │      - qty_available                                             │   │
│  │      - is_active = true                                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│                   ImportBatch.status = "published"                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.3 Важные правила

1. **Только confirmed mappings** — офферы без подтверждённого маппинга НЕ публикуются
2. **Один активный batch** — при публикации нового прайса старые офферы деактивируются
3. **Soft delete** — офферы не удаляются, а помечаются `is_active=false`

---

## 6. Поиск офферов (Retail Search)

### 6.1 Диаграмма

```
┌───────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│   Покупатель  │───▶│   Фильтры     │───▶│   Query       │───▶│   Результаты  │
│   (поиск)     │    │   + текст     │    │   offers      │    │   (сортировка)│
└───────────────┘    └───────────────┘    └───────────────┘    └───────────────┘
```

### 6.2 API поиска

```
GET /offers?product_type=rose&variety=freedom&min_length=50&max_price=150
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          OfferService.search()                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  SELECT offers.*                                                        │
│  FROM offers                                                            │
│  JOIN normalized_skus ON offers.normalized_sku_id = normalized_skus.id  │
│  JOIN suppliers ON offers.supplier_id = suppliers.id                    │
│  WHERE offers.is_active = true                                          │
│    AND normalized_skus.product_type = ?                                 │
│    AND normalized_skus.variety ILIKE ?                                  │
│    AND normalized_skus.length_cm >= ?                                   │
│    AND offers.price_min <= ?                                            │
│  ORDER BY offers.price_min ASC                                          │
│  LIMIT 50                                                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.3 Фильтры

| Параметр | Тип | Описание |
|----------|-----|----------|
| `product_type` | string | Тип продукта (rose, chrysanthemum) |
| `variety` | string | Сорт (Freedom, Explorer) |
| `min_length` | int | Минимальная длина (cm) |
| `max_length` | int | Максимальная длина (cm) |
| `min_price` | float | Минимальная цена |
| `max_price` | float | Максимальная цена |
| `supplier_id` | uuid | Конкретный поставщик |
| `q` | string | Полнотекстовый поиск |

---

## 7. Создание заказа (Order Flow)

### 7.1 Диаграмма

```
┌───────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│   Покупатель  │───▶│   Выбирает    │───▶│   Создаёт     │───▶│    Order      │
│               │    │   офферы      │    │   заказ       │    │   (pending)   │
└───────────────┘    └───────────────┘    └───────────────┘    └───────────────┘
                                                                      │
                                                                      ▼
                                                               OrderItems
```

### 7.2 Создание заказа

```
POST /orders
{
  "items": [
    {"offer_id": "uuid-1", "quantity": 10},
    {"offer_id": "uuid-2", "quantity": 5}
  ],
  "delivery_address": "...",
  "notes": "..."
}
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       OrderService.create_order()                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. Валидация                                                     │   │
│  │    - Проверить что все offer_id существуют и активны            │   │
│  │    - Проверить что quantity > 0                                  │   │
│  │    - Покупатель авторизован                                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 2. Группировка по поставщикам                                    │   │
│  │    - Офферы от разных поставщиков → разные sub-orders           │   │
│  │    - (MVP: один Order с items от разных suppliers)              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 3. Расчёт total                                                  │   │
│  │    - SUM(offer.price_min * quantity)                            │   │
│  │    - (Диапазонные цены: используем price_min)                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 4. Создание Order + OrderItems                                   │   │
│  │    - Order(status="pending", buyer_id, total)                   │   │
│  │    - OrderItem(order_id, offer_id, quantity, price_at_order)    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.3 Статусы заказа

```
pending ──▶ confirmed ──▶ shipped ──▶ delivered
   │            │
   │            ▼
   │        rejected
   │
   ▼
cancelled
```

| Статус | Описание | Кто меняет |
|--------|----------|------------|
| `pending` | Заказ создан, ждёт подтверждения | Система |
| `confirmed` | Поставщик подтвердил | Поставщик |
| `rejected` | Поставщик отклонил | Поставщик |
| `shipped` | Отправлен | Поставщик |
| `delivered` | Доставлен | Поставщик/Покупатель |
| `cancelled` | Отменён покупателем | Покупатель |

---

## 8. Подтверждение/Отклонение заказа (Supplier Order Flow)

### 8.1 Диаграмма

```
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│   Поставщик   │───▶│   Видит       │───▶│   Confirm/    │
│   (login)     │    │   свои заказы │    │   Reject      │
└───────────────┘    └───────────────┘    └───────────────┘
```

### 8.2 Endpoints

```
# Список заказов поставщика
GET /admin/supplier-orders?status=pending

# Подтвердить заказ
POST /admin/supplier-orders/{order_id}/confirm

# Отклонить заказ
POST /admin/supplier-orders/{order_id}/reject
{
  "reason": "Товар закончился"
}
```

### 8.3 Логика подтверждения

```
POST /admin/supplier-orders/{order_id}/confirm
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    OrderService.confirm_order()                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. Проверка прав                                                 │   │
│  │    - supplier_id текущего пользователя == order.supplier_id     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 2. Проверка статуса                                              │   │
│  │    - order.status == "pending"                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 3. Обновление статуса                                            │   │
│  │    - order.status = "confirmed"                                  │   │
│  │    - order.confirmed_at = NOW()                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 4. (Опционально) Уведомление покупателя                         │   │
│  │    - Email/SMS notification                                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 9. Сводная таблица Endpoints по Workflows

| Workflow | Endpoint | Метод | Роль |
|----------|----------|-------|------|
| Onboarding | `/admin/suppliers` | POST | Admin |
| Import | `/admin/suppliers/{id}/imports/csv` | POST | Admin |
| Import status | `/admin/imports/{id}` | GET | Admin |
| Propose | `/admin/normalization/propose` | POST | Admin |
| Review tasks | `/admin/normalization/tasks` | GET | Admin |
| Confirm mapping | `/admin/normalization/confirm` | POST | Admin |
| Create SKU | `/admin/skus` | POST | Admin |
| Publish | `/admin/publish/suppliers/{id}` | POST | Admin |
| Search | `/offers` | GET | Public |
| Create order | `/orders` | POST | Buyer |
| My orders | `/orders` | GET | Buyer |
| Supplier orders | `/admin/supplier-orders` | GET | Supplier |
| Confirm order | `/admin/supplier-orders/{id}/confirm` | POST | Supplier |
| Reject order | `/admin/supplier-orders/{id}/reject` | POST | Supplier |

---

## 10. Связанные документы

- [ARCHITECTURE.md](ARCHITECTURE.md) — общая архитектура
- [CORE_DATA_MODEL.md](CORE_DATA_MODEL.md) — модель данных
- [IMPORT_PIPELINE.md](IMPORT_PIPELINE.md) — детали импорта
- [NORMALIZATION_RULES.md](NORMALIZATION_RULES.md) — правила нормализации
- [ADMIN_API.md](ADMIN_API.md) — API документация
