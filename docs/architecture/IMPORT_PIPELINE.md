# üîÑ IMPORT_PIPELINE ‚Äî MVP (raw ‚Üí parsed ‚Üí normalized ‚Üí published)

## 0) –¶–µ–ª—å

–û–±–µ—Å–ø–µ—á–∏—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π –∏ –Ω–∞–±–ª—é–¥–∞–µ–º—ã–π –∏–º–ø–æ—Ä—Ç –ø—Ä–∞–π—Å–æ–≤ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤:
- "—Å—Ç—Ä–æ—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞" (–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ/—Ü–µ–Ω–∞/–∫–æ–ª-–≤–æ/‚Ä¶)
- "–∏–µ—Ä–∞—Ä—Ö–∏—è" (–≥—Ä—É–ø–ø–∞ ‚Üí –ø–æ–∑–∏—Ü–∏–∏)
- "–º–∞—Ç—Ä–∏—Ü–∞ —Ü–µ–Ω" (–¥–ª–∏–Ω–∞ √ó —É–ø–∞–∫–æ–≤–∫–∞)
- "—Ç–∏—Ä—ã –ø–æ –æ–±—ä—ë–º—É" (–æ—Ç 100 –¥–æ 200 —à—Ç)
- "–¥–∏–∞–ø–∞–∑–æ–Ω—ã —Ü–µ–Ω" (95‚Äì99)
- **PDF** (—Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ pdfplumber / AI-fallback –∏–∑ —Ç–µ–∫—Å—Ç–∞)
- **–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è** (—Å–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Üí AI –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ)

Pipeline –æ–±—è–∑–∞–Ω:
- —Å–æ—Ö—Ä–∞–Ω—è—Ç—å raw –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–º,
- –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å –≤—Ö–æ–¥ –≤ –ø–ª–æ—Å–∫–∏–µ offer_candidate,
- —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ—à–∏–±–∫–∏/–∞–Ω–æ–º–∞–ª–∏–∏,
- –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ä—É—á–Ω–æ–π —Ä–∞–∑–±–æ—Ä –∏ –ø–µ—Ä–µ–ø—É–±–ª–∏–∫–∞—Ü–∏—é.

---

## 1) –í—Ö–æ–¥—ã –∏ –≤—ã—Ö–æ–¥—ã

### –í—Ö–æ–¥
- —Ñ–∞–π–ª/–∏—Å—Ç–æ—á–Ω–∏–∫: CSV/XLSX/PDF (–≤—Å–µ three —Ñ–æ—Ä–º–∞—Ç—ã first-class), Image (–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–æ)
- supplier_id
- (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –¥–∞—Ç–∞ –ø—Ä–∞–π—Å–∞/—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### –í—ã—Ö–æ–¥
- import_batches.status = published
- offers –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω—ã –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–∞—Ä—Ç–∏–∏ + confirmed mappings

---

## 2) –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞ (—ç—Ç–∞–ø—ã)

### Stage A ‚Äî Ingestion (–∑–∞–≥—Ä—É–∑–∫–∞)
**–¶–µ–ª—å:** —Å–æ–∑–¥–∞—Ç—å –ø–∞—Ä—Ç–∏—é –∏–º–ø–æ—Ä—Ç–∞.

**–î–µ–π—Å—Ç–≤–∏—è:**
1) —Å–æ–∑–¥–∞—ë–º `import_batches`:
   - supplier_id
   - source_type
   - source_filename
   - declared_effective_date (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - status = received

2) —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –≤ storage (S3/Yandex Object Storage) –∏ –∫–ª–∞–¥—ë–º –≤ `import_batches.meta`:
   - file_url / storage_key
   - file_hash (sha256)
   - uploader (user_id)

**–¢–∞–±–ª–∏—Ü—ã:**
- import_batches

---

### Stage B ‚Äî RAW extraction (—Ä–∞–∑–±–æ—Ä –Ω–∞ —Å—Ç—Ä–æ–∫–∏/—è—á–µ–π–∫–∏)
**–¶–µ–ª—å:** —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å raw ‚Äú–∫–∞–∫ –µ—Å—Ç—å‚Äù.

**–î–µ–π—Å—Ç–≤–∏—è:**
1) —á–∏—Ç–∞–µ–º —Ñ–∞–π–ª:
   - CSV: rows ‚Üí –º–∞—Å—Å–∏–≤—ã —è—á–µ–µ–∫
   - XLSX: –ª–∏—Å—Ç—ã ‚Üí —Å—Ç—Ä–æ–∫–∏ ‚Üí —è—á–µ–π–∫–∏
   - PDF (—Ç–∞–±–ª–∏—Ü—ã): pdfplumber –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã ‚Üí —Å—Ç—Ä–æ–∫–∏/—è—á–µ–π–∫–∏
   - PDF (—Ç–µ–∫—Å—Ç, AI fallback): –µ—Å–ª–∏ pdfplumber –Ω–µ –Ω–∞—à—ë–ª —Ç–∞–±–ª–∏—Ü ‚Üí `extract_pdf_text()` ‚Üí `ai_extract_price_from_text()` —á–µ—Ä–µ–∑ DeepSeek ‚Üí —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–∫ (—Å–º. Stage B2)

2) –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –ø–∏—à–µ–º `raw_rows`:
   - raw_cells (json)
   - raw_text (–∫–æ–Ω–∫–∞—Ç —è—á–µ–µ–∫)
   - row_ref (sheet/page/row)

3) –ø–µ—Ä–≤–∏—á–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è row_kind:
   - header / group / data / comment / empty

**–¢–∞–±–ª–∏—Ü—ã:**
- raw_rows

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- parse_events (–µ—Å–ª–∏ —Ñ–∞–π–ª –±–∏—Ç—ã–π/–Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è)

---

### Stage B2 ‚Äî AI Text Extraction Fallback (PDF –±–µ–∑ —Ç–∞–±–ª–∏—Ü)
**–¶–µ–ª—å:** –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –Ω–µ—Ç–∞–±–ª–∏—á–Ω—ã—Ö PDF (–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø—Ä–∞–π—Å—ã).

**–£—Å–ª–æ–≤–∏–µ –∑–∞–ø—É—Å–∫–∞:** Stage B –¥–ª—è PDF –Ω–µ –Ω–∞—à–ª–∞ –Ω–∏ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã (pdfplumber –≤–µ—Ä–Ω—É–ª 0 —Å—Ç—Ä–æ–∫).

**–î–µ–π—Å—Ç–≤–∏—è:**
1) `extract_pdf_text(content)` ‚Äî –∏–∑–≤–ª–µ–∫–∞–µ—Ç –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∏–∑ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü PDF —á–µ—Ä–µ–∑ PyMuPDF (`fitz`)
2) –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç < 20 —Å–∏–º–≤–æ–ª–æ–≤ ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (—Ñ–∞–π–ª –±–µ–∑ —Ç–µ–∫—Å—Ç–∞)
3) `ai_extract_price_from_text(raw_text)` ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –≤ DeepSeek:
   - –ú–æ–¥–µ–ª—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ (`price_list`, `commercial_offer`, `invoice`, `other`)
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏: `name`, `price`, `unit`, `pack_qty`
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON
4) AI-–æ—Ç–≤–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–∫: `[{"row_number": N, "cells": [name, unit, price], "headers": [...]}]`
5) –°—Ç—Ä–æ–∫–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ `_process_rows()` –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ CSV-—Å—Ç—Ä–æ–∫–∏

**–ú–æ–¥—É–ª—å:** `packages/core/ai/text_extraction.py`

**–ü—Ä–æ–º–ø—Ç:** `SYSTEM_PROMPT_TEXT_PRICE_EXTRACTION` –≤ `packages/core/ai/prompts.py`

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- `AI_ENABLED=true` –≤ `.env`
- `DEEPSEEK_API_KEY` –∑–∞–¥–∞–Ω
- –ú–∞–∫—Å–∏–º—É–º ~64K —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–∫—Å—Ç–∞ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ DeepSeek)

**–ï—Å–ª–∏ AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:** –∏–º–ø–æ—Ä—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è, batch –ø–æ–ª—É—á–∞–µ—Ç status=`failed` —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º "no tables found".

**–¢–∞–±–ª–∏—Ü—ã:**
- raw_rows (AI-–∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ)
- parse_events (–ø—Ä–∏ –æ—à–∏–±–∫–µ AI)

---

### Stage B3 ‚Äî AI Column Mapping Fallback (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏)
**–¶–µ–ª—å:** –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –ø–æ–ª—è–º, –∫–æ–≥–¥–∞ keyword-matching –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª –∑–∞–≥–æ–ª–æ–≤–∫–∏.

**–£—Å–ª–æ–≤–∏–µ –∑–∞–ø—É—Å–∫–∞:** –ø–æ—Å–ª–µ keyword-based `normalize_headers()`, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `price` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ).

**–î–µ–π—Å—Ç–≤–∏—è:**
1) `ai_detect_column_mapping(headers, sample_rows)` ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ + 3‚Äì5 —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö –≤ DeepSeek
2) AI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{"column_mapping": [{"source_index": N, "target_field": "...", "confidence": 0.XX}]}`
3) –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –º–∞–ø–ø–∏–Ω–≥–∏ —Å `confidence >= 0.60`
4) –í–∞–ª–∏–¥–∞—Ü–∏—è: `source_index` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö `[0, len(headers))`
5) –†–µ–∑—É–ª—å—Ç–∞—Ç: —Å–ª–æ–≤–∞—Ä—å `{field_name: column_index}` –≤ —Ñ–æ—Ä–º–∞—Ç–µ `normalize_headers()`

**–ú–æ–¥—É–ª—å:** `packages/core/ai/column_mapping.py`

**–ü—Ä–æ–º–ø—Ç:** `SYSTEM_PROMPT_COLUMN_MAPPING` –≤ `packages/core/ai/prompts.py`

**–ï—Å–ª–∏ AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:** –ø–∞—Ä—Å–µ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å keyword-–º–∞–ø–ø–∏–Ω–≥–æ–º; –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ ‚Üí `parse_event(HEADER_NOT_FOUND)`.

**–¢–∞–±–ª–∏—Ü—ã:**
- parse_events (–∑–∞–ø–∏—Å—å AI-–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞ –¥–ª—è –∞—É–¥–∏—Ç–∞)

---

### Stage C ‚Äî Parse run (—Ç–∏–ø–∏–∑–∞—Ü–∏—è –∏ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π)
**–¶–µ–ª—å:** —Å–æ–∑–¥–∞—Ç—å parse_run –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å parsed —Å–ª–æ–π.

**–î–µ–π—Å—Ç–≤–∏—è:**
1) —Å–æ–∑–¥–∞—ë–º `parse_runs`:
   - parser_version
   - started_at

2) –æ–ø—Ä–µ–¥–µ–ª—è–µ–º ‚Äú—Ñ–æ—Ä–º–∞—Ç‚Äù –ø–∞—Ä—Ç–∏–∏ (heuristics):
   - –Ω–∞–ª–∏—á–∏–µ –∫–æ–ª–æ–Ω–æ–∫ ‚Äú–¶–µ–Ω–∞/–ö–æ–ª-–≤–æ/–°—É–º–º–∞‚Äù
   - –Ω–∞–ª–∏—á–∏–µ –º–∞—Ç—Ä–∏—Ü—ã (–∫–æ–ª–æ–Ω–∫–∏ –≤–∏–¥–∞ ‚Äú40 —Å–º –±–∞–∫ / 50 —Å–º —É–ø–∞–∫‚Äù)
   - –Ω–∞–ª–∏—á–∏–µ —Ç–∏—Ä–æ–≤ –ø–æ –æ–±—ä—ë–º—É (‚Äú–æ—Ç 100 –¥–æ 200‚Äù)
   - –Ω–∞–ª–∏—á–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (‚Äú95-99‚Äù, ‚Äú95‚Äì99‚Äù, ‚Äú95—Ä - 99—Ä‚Äù)

3) —Å—Ç—Ä–æ–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏:
   - –µ—Å–ª–∏ –≤—Å—Ç—Ä–µ—á–∞–µ–º —Å—Ç—Ä–æ–∫–∏-–≥—Ä—É–ø–ø—ã: —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π `raw_group_context`
   - –∫–∞–∂–¥–æ–π data-—Å—Ç—Ä–æ–∫–µ –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º raw_group = group_context

4) –∏–∑–≤–ª–µ–∫–∞–µ–º supplier_item:
   - raw_name = –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (–∫–∞–∫ –µ—Å—Ç—å)
   - raw_group = group_context (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - name_norm = –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (lower, trim, replace, remove stopwords)
   - attributes (json): —Å—Ç—Ä–∞–Ω–∞/–±—Ä–µ–Ω–¥/—Å–æ—Ä—Ç (–µ—Å–ª–∏ –∏–∑–≤–ª–µ–∫–ª–∏)
   - stable_key = hash(supplier_id + raw_group + normalized_name)

5) –∏–∑–≤–ª–µ–∫–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã –∏–∑ raw_name (**–∏—Å–ø–æ–ª—å–∑—É—è –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π –∫–∞—Ç–∞–ª–æ–≥**):
   - **flower_type** ‚Äî —Ç–∏–ø —Ü–≤–µ—Ç–∫–∞ (–†–æ–∑–∞, –•—Ä–∏–∑–∞–Ω—Ç–µ–º–∞...)
     - lookup –∏–∑ `flower_types` + `type_synonyms` —Å –∫—ç—à–µ–º (TTL=5 –º–∏–Ω)
     - fallback –Ω–∞ hardcoded —Å–ª–æ–≤–∞—Ä—å FLOWER_TYPES_FALLBACK
   - **flower_subtype** ‚Äî —Å—É–±—Ç–∏–ø (–ö—É—Å—Ç–æ–≤–∞—è, –°–ø—Ä–µ–π, –ü–∏–æ–Ω–æ–≤–∏–¥–Ω–∞—è)
     - lookup –∏–∑ `flower_subtypes` + `subtype_synonyms` (–ø–æ type_id)
   - **variety** ‚Äî —Å–æ—Ä—Ç (–æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–∏–ø–∞/—Å—É–±—Ç–∏–ø–∞/—Å—Ç—Ä–∞–Ω—ã/–¥–ª–∏–Ω—ã)
   - **origin_country** ‚Äî —Å—Ç—Ä–∞–Ω–∞ (–∏–∑ —Å–∫–æ–±–æ–∫ –∏–ª–∏ —Ä–µ–≥—É–ª—è—Ä–∫–∏)
   - **length_cm** ‚Äî –¥–ª–∏–Ω–∞ –≤ —Å–º
   - **colors** ‚Äî —Ü–≤–µ—Ç–∞ (–º–∏–∫—Å, –∫—Ä–∞—Å–Ω—ã–π –∏ —Ç.–¥.)

   > –ü–∞—Ä—Å–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç API `/admin/catalog/lookup` –∏–ª–∏ –ø—Ä—è–º–æ–π async –∑–∞–ø—Ä–æ—Å –∫ –ë–î.

5) –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ —Å–æ–∑–¥–∞—ë–º `offer_candidates` (—Å–º. Stage D ‚Äî —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ).

**–¢–∞–±–ª–∏—Ü—ã:**
- parse_runs
- supplier_items
- offer_candidates (—á–µ—Ä–µ–∑ Stage D)
- parse_events (–æ—à–∏–±–∫–∏)

---

### Stage D ‚Äî Expansion (—Ä–∞—Å–∫—Ä—ã—Ç–∏–µ –º–∞—Ç—Ä–∏—Ü/—Ç–∏—Ä–æ–≤/–¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –≤ ‚Äú–ø–ª–æ—Å–∫–∏–µ‚Äù offer_candidate)
**–¶–µ–ª—å:** –ª—é–±–æ–π —Å–ª–æ–∂–Ω—ã–π –ø—Ä–∞–π—Å –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –≤–∏–¥—É: –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å = –æ–¥–∏–Ω ‚Äú–∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ñ—Ñ–µ—Ä–∞‚Äù.

#### D1) –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (simple row)
**–ü—Ä–∏–º–µ—Ä:** –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ + –¶–µ–Ω–∞ (+ –ö–æ–ª-–≤–æ)
- length_cm / pack_qty / origin / brand ‚Üí –ø–∞—Ä—Å–∏–º –∏–∑ raw_name regex-–∞–º–∏
- price_min = price
- price_type = fixed
- price_max = NULL

–°–æ–∑–¥–∞—ë–º 1 offer_candidate.

#### D2) –î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω—ã
**–ü—Ä–∏–º–µ—Ä:** 95‚Äì99
- price_type = range
- price_min = 95
- price_max = 99

#### D3) –¢–∏—Ä—ã –ø–æ –æ–±—ä—ë–º—É
**–ü—Ä–∏–º–µ—Ä:** ‚Äú–æ—Ç 100 –¥–æ 200 —à—Ç‚Äù –∫–∞–∫ –∫–æ–ª–æ–Ω–∫–∏/—Å—Ç—Ä–æ–∫–∏
- —Å–æ–∑–¥–∞—ë–º –Ω–µ—Å–∫–æ–ª—å–∫–æ offer_candidate:
  - tier_min_qty=100, tier_max_qty=200, price_min=...
  - tier_min_qty=201, tier_max_qty=500, price_min=...

> –í MVP —Ç–∏—Ä–∞–º–∏ —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ dimension = qty (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ).

#### D4) –ú–∞—Ç—Ä–∏—Ü–∞ (–¥–ª–∏–Ω–∞ √ó —É–ø–∞–∫–æ–≤–∫–∞)
**–ü—Ä–∏–º–µ—Ä:** –∫–æ–ª–æ–Ω–∫–∏ ‚Äú40 —Å–º –±–∞–∫‚Äù, ‚Äú40 —Å–º —É–ø–∞–∫‚Äù, ‚Äú50 —Å–º –±–∞–∫‚Äù‚Ä¶
- –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —è—á–µ–π–∫–∏:
  - length_cm = 40/50/...
  - pack_type = –±–∞–∫/—É–ø–∞–∫
  - price_min = value
  - —Å–æ–∑–¥–∞—ë–º –æ—Ç–¥–µ–ª—å–Ω—ã–π offer_candidate

#### D5) "–°–ø–∏—Å–æ–∫ —Å–æ—Ä—Ç–æ–≤ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ" (Bundle auto-expansion)
**–ü—Ä–∏–º–µ—Ä:** "–†–æ–∑–∞ –ê–≤–∞–ª–∞–Ω—à, –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞, –ë–∞—Ä–∞–∫—É–¥–∞, –ö–ª–∞—Ä–µ–Ω—Å" + –º–∞—Ç—Ä–∏—Ü–∞ —Ü–µ–Ω

–ü–∞—Ä—Å–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç—Ä–æ–∫–∏-–±–∞–Ω–¥–ª—ã (3+ —Å–æ—Ä—Ç–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é) –∏ —Ä–∞–∑–±–∏–≤–∞–µ—Ç –∏—Ö
–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ supplier_item + offer_candidate –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ä—Ç–∞.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. `_detect_bundle_list()` –≤ name_normalizer –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±–∞–Ω–¥–ª –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–æ—Ä—Ç–æ–≤
2. `_build_expanded_varieties()` –≤ import_service –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ä—Ç–∞:
   - —Å—Ç—Ä–æ–∏—Ç —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–æ–µ –∏–º—è: `"{—Ç–∏–ø} {—Å—É–±—Ç–∏–ø} {—Å–æ—Ä—Ç}"` (–Ω–∞–ø—Ä. "–†–æ–∑–∞ —Å–ø—Ä–µ–π –õ–∏–¥–∏—è")
   - –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —á–µ—Ä–µ–∑ `normalize_name()`
   - –Ω–∞—Å–ª–µ–¥—É–µ—Ç —Å—Ç—Ä–∞–Ω—É –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ä—Ç–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π SupplierItem —Å–æ `stable_key` –æ—Ç —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–º–µ–Ω–∏
4. –ö–∞–∂–¥—ã–π —Å–æ—Ä—Ç –ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —Ü–µ–Ω—ã –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ (–ø–æ–ª–Ω—É—é –º–∞—Ç—Ä–∏—Ü—É –¥–ª–∏–Ω/—É–ø–∞–∫–æ–≤–æ–∫)
5. –ê—Ç—Ä–∏–±—É—Ç—ã: `origin="bundle_expansion"`, `bundle_source="{–∏—Å—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞}"`
6. Parse event: `BUNDLE_EXPANDED` (severity=info)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** "–†–æ–∑–∞ –ê–≤–∞–ª–∞–Ω—à, –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞, –ë–∞—Ä–∞–∫—É–¥–∞" ‚Üí 3 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö SupplierItem, –∫–∞–∂–¥—ã–π
–ø—É–±–ª–∏–∫—É–µ–º—ã–π –∏ –Ω–∞—Ö–æ–¥–∏–º—ã–π —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫.

**RAW –Ω–µ —Ç—Ä–æ–≥–∞–µ–º** ‚Äî –∏—Å—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ raw_rows –∫–∞–∫ –µ—Å—Ç—å.

**–¢–∞–±–ª–∏—Ü—ã:**
- offer_candidates
- parse_events (–µ—Å–ª–∏ –º–∞—Ç—Ä–∏—Ü–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ / —Å—Ç—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)

---

### Stage E ‚Äî Validation (–∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö)
**–¶–µ–ª—å:** –ø—Ä–∏—Å–≤–æ–∏—Ç—å validation_status –∫–∞–Ω–¥–∏–¥–∞—Ç—É –æ—Ñ—Ñ–µ—Ä–∞.

**–ü—Ä–∞–≤–∏–ª–∞ MVP:**
- error:
  - price_min is null / <0
  - tier_min_qty XOR tier_max_qty
  - length_cm <=0
- warn:
  - price_type=fixed, –Ω–æ price_max –∑–∞–ø–æ–ª–Ω–µ–Ω
  - pack_type –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω (–Ω–µ—Ç –≤ dictionary pack_type)
  - –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (–≤ 10 —Ä–∞–∑ –≤—ã—à–µ –º–µ–¥–∏–∞–Ω—ã –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É)
- ok:
  - –≤—Å—ë –Ω–æ—Ä–º

–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∏—à–µ–º –≤:
- offer_candidates.validation
- offer_candidates.validation_notes

---

### Stage F ‚Äî Mark batch parsed
**–¶–µ–ª—å:** –∑–∞–≤–µ—Ä—à–∏—Ç—å parse_run –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–∞—Ä—Ç–∏–∏.

**–î–µ–π—Å—Ç–≤–∏—è:**
- parse_runs.finished_at
- parse_runs.summary (counts)
- import_batches.status = parsed

---

### Stage G ‚Äî Normalization precompute (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–ø–ø–∏–Ω–≥–∞)
**–¶–µ–ª—å:** –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏.

**–î–µ–π—Å—Ç–≤–∏—è (MVP):**
- –¥–ª—è supplier_items, —É –∫–æ—Ç–æ—Ä—ã—Ö:
  - status=active
  - –Ω–µ—Ç confirmed mapping
  - –∑–∞–ø—É—Å–∫–∞–µ–º ‚Äúrule-based propose‚Äù:
    - —á–∏—Å—Ç–∏–º name_norm
    - –ø—Ä–∏–º–µ–Ω—è–µ–º dictionary rules (—Å–∏–Ω–æ–Ω–∏–º—ã, regex replacements)
    - –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ normalized_sku –ø–æ tokens

–°–æ–∑–¥–∞—ë–º sku_mappings —Å–æ status=proposed –∏ confidence.

*(–ü–æ–¥—Ä–æ–±–Ω–æ ‚Äî –≤ NORMALIZATION_RULES.md –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ.)*

---

### Stage H ‚Äî Publish (–ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ offers)
**–¶–µ–ª—å:** –∏–∑ offer_candidates —Å–¥–µ–ª–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ offers.

**–£—Å–ª–æ–≤–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:**
- supplier.status=active
- sku_mappings.status=confirmed (–¥–ª—è supplier_item)
- offer_candidates.validation IN (ok, warn)

**–î–µ–π—Å—Ç–≤–∏—è:**
1) –≤—ã–±–∏—Ä–∞–µ–º latest import_batch –¥–ª—è supplier (–∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–∞—Ä—Ç–∏—é)
2) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ supplier_item –±–µ—Ä—ë–º confirmed mapping ‚Üí normalized_sku_id
3) –ø–æ –∫–∞–∂–¥–æ–º—É offer_candidate —Å–æ–∑–¥–∞—ë–º offers:
   - –ø–µ—Ä–µ–Ω–æ—Å–∏–º length_cm/pack_type/pack_qty/price/tier/availability/stock
   - source_import_batch_id = import_batch_id
   - is_active=true
4) –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ offers —ç—Ç–æ–≥–æ supplier, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –Ω–æ–≤–æ–π –ø–∞—Ä—Ç–∏–∏ (–∏–ª–∏ –≤—ã—Å—Ç–∞–≤–ª—è–µ–º is_active=false –ø–æ strategy)

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ (MVP):**
- –¥–ª—è –∫–∞–∂–¥–æ–≥–æ supplier –ø—É–±–ª–∏–∫—É–µ–º —Ç–æ–ª—å–∫–æ offers –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π successful –ø–∞—Ä—Ç–∏–∏
- —Å—Ç–∞—Ä—ã–µ offers ‚Üí is_active=false

**–¢–∞–±–ª–∏—Ü—ã:**
- offers
- import_batches.status = published

---

## 3) –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å –∏ –¥–µ–±–∞–≥

### KPI –ø–æ –ø–∞—Ä—Ç–∏–∏
–°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ parse_runs.summary:
- raw_rows_total
- raw_rows_data
- supplier_items_created
- offer_candidates_created
- validation_ok / warn / error
- unmapped_items_count
- publishable_candidates_count

### –õ–æ–≥–∏/–æ—à–∏–±–∫–∏
- parse_events: –æ—à–∏–±–∫–∏ —á—Ç–µ–Ω–∏—è, –º–∞—Ç—Ä–∏—Ü–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞, –º—É—Å–æ—Ä–Ω—ã–µ —Ü–µ–Ω—ã, etc.

### Re-run —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
- Raw –Ω–µ –º–µ–Ω—è–µ–º.
- –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–∞—Ä—Å–∞:
  - —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π parse_run –¥–ª—è —Ç–æ–π –∂–µ import_batch
  - –ª–∏–±–æ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é import_batch, –µ—Å–ª–∏ —Ñ–∞–π–ª –∏–∑–º–µ–Ω–∏–ª—Å—è

---

## 4) –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è MVP (–≤–∞–∂–Ω—ã–µ)

1) **PDF** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: —Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ pdfplumber, –Ω–µ—Ç–∞–±–ª–∏—á–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ AI text extraction (DeepSeek).
2) **Image** ‚Äî –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (OCR –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –≤–Ω–µ MVP).
3) –ú–∞—Ç—Ä–∏—Ü—ã –∏ —Ç–∏—Ä—ã –≤—Å–µ–≥–¥–∞ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –≤ –ø–ª–æ—Å–∫–∏–µ offer_candidate.
4) "–°–ø–∏—Å–æ–∫ —Å–æ—Ä—Ç–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ" ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ (bundle auto-expansion, Stage D5).
5) –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ confirmed mapping.
6) –õ—é–±–∞—è –æ—à–∏–±–∫–∞ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è ‚Äî –æ—Å—Ç–∞—ë—Ç—Å—è –≤ raw + parse_events.
7) **AI-fallback –ø—Ä–∏–Ω—Ü–∏–ø**: –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –≤—Å–µ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º; AI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö (–Ω–µ—Ç —Ç–∞–±–ª–∏—Ü –≤ PDF, –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏). –ï—Å–ª–∏ AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –∏–º–ø–æ—Ä—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –±–µ–∑ –Ω–µ–≥–æ.