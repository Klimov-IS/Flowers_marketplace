# Техническое задание: Telegram-бот для B2B Flower Market

**Версия:** 1.0
**Дата:** 23.02.2026
**Статус:** На согласовании
**Спринт:** TG-Bot

---

## 1. Общее описание

### 1.1 Назначение

Telegram-бот — дополнительный интерфейс к существующей платформе B2B Flower Market. Бот позволяет поставщикам и покупателям выполнять основные операции (загрузка прайса, поиск товаров, управление заказами) не выходя из Telegram.

### 1.2 Целевые пользователи

| Роль | Описание | Основной сценарий |
|------|----------|-------------------|
| **Поставщик** (Supplier) | Оптовая база цветов | Загрузить прайс, получить и обработать заказ |
| **Покупатель** (Buyer) | Розничный магазин / флорист | Найти товар, оформить заказ, отслеживать статус |

### 1.3 Бизнес-цели

1. **Снизить порог входа** — поставщику не нужен компьютер для загрузки прайса
2. **Ускорить обработку заказов** — push-уведомление вместо проверки web-кабинета
3. **Увеличить конверсию покупателей** — поиск и заказ через знакомый интерфейс
4. **Оперативность** — среднее время реакции на заказ < 5 минут (vs 1-2 часа через web)

### 1.4 Связь с существующей системой

Бот **не является** отдельной системой. Это клиент к существующему FastAPI-бэкенду:

```
Telegram Bot (новый)  ──HTTP──▶  FastAPI API (существующий)  ──▶  PostgreSQL
```

Бот не имеет прямого доступа к БД. Все операции выполняются через API.

---

## 2. Архитектура

### 2.1 Компоненты

```
┌─────────────────────────────────────────────────────────────┐
│                     Telegram Cloud                          │
└─────────────────────────┬───────────────────────────────────┘
                          │ HTTPS (Webhook)
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  nginx (существующий)                                       │
│  location /flower/bot/webhook → http://127.0.0.1:8081      │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│  apps/bot/  — Telegram Bot Service (НОВЫЙ)                  │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────────────┐ │
│  │  Handlers    │ │  API Client  │ │  Notification Worker │ │
│  │  (onboard,   │ │  (httpx →    │ │  (фоновый опрос      │ │
│  │   upload,    │ │   FastAPI)   │ │   очереди событий)   │ │
│  │   orders,    │ │              │ │                      │ │
│  │   search)    │ │              │ │                      │ │
│  └──────────────┘ └──────────────┘ └──────────────────────┘ │
│  Порт: 8081 | python-telegram-bot v21 (async)               │
└─────────────────────────┬───────────────────────────────────┘
                          │ HTTP (localhost)
┌─────────────────────────▼───────────────────────────────────┐
│  apps/api/  — FastAPI (существующий, порт 8000)             │
│  + НОВЫЙ роутер: /internal/telegram/*                       │
└─────────────────────────┬───────────────────────────────────┘
                          │
                  ┌───────▼────────┐
                  │   PostgreSQL   │
                  │  (существующий) │
                  └────────────────┘
```

### 2.2 Технологический стек

| Компонент | Технология | Обоснование |
|-----------|------------|-------------|
| Bot framework | `python-telegram-bot` v21+ | Async-native, активная поддержка, Python |
| HTTP client | `httpx` (async) | Уже используется в проекте для тестов |
| Кэш/сессии | Redis | Корзина покупателя, rate limiting, TTL сессий |
| БД | PostgreSQL (общая) | Таблицы `telegram_links`, `notification_queue` |
| Процесс | systemd service `flower-bot` | Единообразно с `flower-api` |
| Режим работы | Webhook (не polling) | Production-grade, один порт, за nginx |

### 2.3 Принципы

1. **Бот = тонкий клиент.** Вся бизнес-логика остаётся в API.
2. **Никаких прямых SQL-запросов** из кода бота.
3. **Internal API** — отдельные эндпоинты для бота, недоступные извне (проверка IP + токен).
4. **Graceful degradation** — если API недоступен, бот отвечает "Сервис временно недоступен".

---

## 3. Модель данных (новые таблицы)

### 3.1 telegram_links

Связь Telegram-аккаунта с сущностью системы (поставщик / покупатель).

```sql
CREATE TABLE telegram_links (
    id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    telegram_user_id  BIGINT UNIQUE NOT NULL,
    telegram_chat_id  BIGINT NOT NULL,
    role              VARCHAR(20) NOT NULL CHECK (role IN ('supplier', 'buyer')),
    entity_id         UUID NOT NULL,
    username          VARCHAR(100),
    first_name        VARCHAR(100),
    is_active         BOOLEAN NOT NULL DEFAULT TRUE,
    linked_at         TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at        TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_telegram_links_entity ON telegram_links(role, entity_id);
CREATE INDEX idx_telegram_links_chat ON telegram_links(telegram_chat_id);
```

**Поля:**
- `telegram_user_id` — уникальный ID пользователя в Telegram (BIGINT)
- `telegram_chat_id` — ID чата для отправки сообщений (обычно = user_id для личных чатов)
- `role` — `supplier` или `buyer`
- `entity_id` — UUID записи из таблицы `suppliers` или `buyers`
- `username` — кэш @username (может меняться)
- `first_name` — кэш имени (для приветствий)

### 3.2 telegram_link_codes

Одноразовые коды для привязки существующего аккаунта.

```sql
CREATE TABLE telegram_link_codes (
    code          VARCHAR(10) PRIMARY KEY,
    entity_type   VARCHAR(20) NOT NULL CHECK (entity_type IN ('supplier', 'buyer')),
    entity_id     UUID NOT NULL,
    created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
    expires_at    TIMESTAMPTZ NOT NULL,
    used_at       TIMESTAMPTZ,
    used_by       BIGINT
);
```

**Поля:**
- `code` — 6-символьный код (формат: `ABC-123`), уникальный
- `entity_type` / `entity_id` — к какой записи привязывается
- `expires_at` — срок действия (24 часа с момента создания)
- `used_at` / `used_by` — когда и кем использован (telegram_user_id)

### 3.3 notification_queue

Очередь уведомлений для отправки через Telegram.

```sql
CREATE TABLE notification_queue (
    id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    recipient_type VARCHAR(20) NOT NULL CHECK (recipient_type IN ('supplier', 'buyer')),
    recipient_id  UUID NOT NULL,
    event_type    VARCHAR(50) NOT NULL,
    payload       JSONB NOT NULL DEFAULT '{}',
    status        VARCHAR(20) NOT NULL DEFAULT 'pending'
                  CHECK (status IN ('pending', 'sent', 'failed', 'skipped')),
    created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
    sent_at       TIMESTAMPTZ,
    error_message TEXT,
    retry_count   INT NOT NULL DEFAULT 0
);

CREATE INDEX idx_notification_queue_pending
    ON notification_queue(status, created_at)
    WHERE status = 'pending';
```

**event_type значения:**
- `new_order` — новый заказ для поставщика
- `order_confirmed` — заказ подтверждён (покупателю)
- `order_rejected` — заказ отклонён (покупателю)
- `import_complete` — прайс обработан (поставщику)
- `import_error` — ошибка обработки прайса (поставщику)
- `price_stale` — прайс устарел, напоминание (поставщику)

---

## 4. Функциональные требования

### 4.1 Модуль: Регистрация и привязка аккаунта (Onboarding)

#### FR-1.1 Команда /start

**Описание:** Точка входа. Бот определяет, зарегистрирован ли пользователь.

**Сценарий (новый пользователь):**

```
Пользователь: /start
Бот: Добро пожаловать в Flower Market!
     Выберите вашу роль:
     [Поставщик]  [Покупатель]
```

**Сценарий (уже привязан):**

```
Пользователь: /start
Бот: Здравствуйте, {first_name}!
     Ваш аккаунт: {company_name} ({role})

     [Загрузить прайс]  (если поставщик)
     [Найти товар]       (если покупатель)
     [Мои заказы]
     [Помощь]
```

#### FR-1.2 Привязка поставщика

**Вариант А — По номеру телефона (основной):**

```
Бот: Для входа отправьте свой номер телефона:
     [Отправить номер телефона]    ← системная кнопка Telegram

Пользователь: (нажимает кнопку, Telegram отправляет верифицированный номер)

Бот (найден): Аккаунт найден! Компания: {name}
              Привязка выполнена.

Бот (не найден): Номер не найден в системе.
                 [Зарегистрироваться]
                 [У меня есть код привязки]
```

**Вариант Б — По коду привязки (fallback):**

```
Бот: Введите код привязки из web-кабинета:

Пользователь: ABC-123

Бот (верный код): Аккаунт привязан! Компания: {name}

Бот (неверный/истёкший): Код недействителен. Проверьте код или обратитесь к администратору.
```

**Вариант В — Новая регистрация:**

```
Бот: Введите название вашей компании:
Пользователь: ООО Росцветторг

Бот: Ваш контактный телефон? (уже получен через кнопку)
     Город? (выбор из списка)

Бот: Заявка создана! Администратор проверит данные и активирует ваш аккаунт.
     Мы пришлём уведомление, когда кабинет будет готов.
```

**Результат:** Создаётся `Supplier` со `status=pending`. Администратор активирует через web-панель.

#### FR-1.3 Привязка покупателя

Аналогично поставщику, но:
- Обязательные поля: имя, телефон, город, адрес доставки
- Покупатель активируется автоматически (`status=active`)
- Дополнительно: бот спрашивает адрес доставки по умолчанию

#### FR-1.4 Требования к авторизации

| Требование | Описание |
|------------|----------|
| Одна привязка | Один Telegram-аккаунт = один аккаунт системы |
| Смена роли | Не поддерживается. Для смены — отвязка + повторная привязка |
| Деактивация | Команда /unlink — отвязывает аккаунт, требует подтверждения |
| Блокировка | Если `supplier.status=blocked` или `buyer.status=blocked` — бот отказывает в действиях |

---

### 4.2 Модуль: Загрузка прайс-листа (только Поставщик)

#### FR-2.1 Отправка файла

**Описание:** Поставщик отправляет файл (CSV/XLSX/PDF) как документ в чат.

**Сценарий (успех):**

```
Поставщик: (отправляет файл "Прайс_декабрь.xlsx")

Бот: Файл получен: Прайс_декабрь.xlsx (145 КБ)
     Обрабатываю...

     (через 3-10 сек)

Бот: Прайс обработан!

     Позиций: 47
     Тип определён: 100%
     Сорт определён: 89%
     Предупреждений: 2

     [Подробнее]  [Опубликовать]
```

**Сценарий (ошибка формата):**

```
Поставщик: (отправляет фото или .doc файл)

Бот: Формат не поддерживается.
     Отправьте прайс-лист в формате: CSV, XLSX или PDF
```

**Сценарий (ошибка парсинга):**

```
Бот: Не удалось обработать файл.
     Ошибка: Не найдены столбцы с наименованием и ценой.

     Убедитесь, что в файле есть заголовки: "Наименование", "Цена"
     Или обратитесь к администратору.
```

#### FR-2.2 Кнопка "Подробнее"

Показывает предупреждения и проблемные строки:

```
Предупреждения (1):

1. Строка 23: Цена 0.50 руб. — подозрительно низкая

Информация:
• Строка 5: "Роза спрей: Лидия, Хейли, Яна, Микс"
  → Автоматически разбито на 4 позиции

[Назад]  [Всё равно опубликовать]
```

#### FR-2.3 Кнопка "Опубликовать"

Запускает публикацию обработанного прайса (обновляет активные предложения на витрине).

```
Бот: Прайс опубликован!
     47 позиций доступны покупателям.

     Предыдущий прайс деактивирован.
```

#### FR-2.4 Ограничения

| Параметр | Значение | Обоснование |
|----------|----------|-------------|
| Максимальный размер файла | 10 МБ | Telegram API лимит — 20 МБ, оставляем запас |
| Поддерживаемые форматы | `.csv`, `.xlsx`, `.xls`, `.pdf` | Существующие парсеры |
| Минимальный интервал загрузки | 1 минута | Защита от случайного дубля |
| Сжатые файлы | Не поддерживаются | `.zip`, `.rar` — не принимаем |

#### FR-2.5 Команда /price

```
Бот: Чтобы загрузить прайс, просто отправьте файл (CSV, XLSX или PDF) в этот чат.

     Последний прайс: 21.02.2026, 47 позиций
     Статус: опубликован
```

---

### 4.3 Модуль: Поиск и заказ (только Покупатель)

#### FR-3.1 Текстовый поиск

**Описание:** Покупатель пишет текстовый запрос — бот ищет по каталогу.

```
Покупатель: розы красные 60

Бот: Найдено 3 предложения:

     1. Роза Ред Наоми 60 см
        Росцветторг — 95 руб./шт (от 10 шт)
        [В корзину]

     2. Роза Фридом 60 см
        Самшит — 85 руб./шт (от 25 шт)
        [В корзину]

     3. Роза Эксплорер 60 см
        Флора Опт — 90 руб./шт (от 10 шт)
        [В корзину]

     [Показать ещё]
```

**API-вызов:** `GET /offers?q=розы+красные&length_min=55&length_max=65`

#### FR-3.2 Команда /search

```
/search гортензия белая

(аналогично текстовому поиску)
```

#### FR-3.3 Добавление в корзину

```
Покупатель: (нажимает "В корзину" у позиции 1)

Бот: Роза Ред Наоми 60 см (Росцветторг)
     Укажите количество (минимум 10 шт):

Покупатель: 25

Бот: Добавлено в корзину!

     Корзина (Росцветторг):
     • Роза Ред Наоми 60 см × 25 шт = 2 375 руб.

     Итого: 2 375 руб.

     [Продолжить покупки]  [Оформить заказ]
```

#### FR-3.4 Просмотр корзины (/cart)

```
Бот: Ваша корзина:

     Росцветторг:
     1. Роза Ред Наоми 60 см × 25 шт — 2 375 руб.
     2. Эустома белая 70 см × 10 шт — 1 800 руб.
     Итого: 4 175 руб.
     [Оформить]  [Очистить]

     Самшит:
     1. Гортензия белая 50 см × 5 шт — 2 250 руб.
     Итого: 2 250 руб.
     [Оформить]  [Очистить]
```

**Важно:** Корзина группируется по поставщику. Один заказ = один поставщик (архитектурное решение платформы, ADR-004).

#### FR-3.5 Оформление заказа

```
Покупатель: (нажимает "Оформить" у Росцветторг)

Бот: Оформление заказа (Росцветторг):

     1. Роза Ред Наоми 60 см × 25 шт — 2 375 руб.
     2. Эустома белая 70 см × 10 шт — 1 800 руб.

     Итого: 4 175 руб.

     Адрес доставки: ул. Пушкина, 10
     [Изменить адрес]

     Желаемая дата доставки:
     [Сегодня]  [Завтра]  [Выбрать дату]

     Комментарий к заказу? (или "Пропустить")

Покупатель: Пропустить

Бот: Заказ #1042 создан!
     Ожидайте подтверждения от поставщика.
     Мы пришлём уведомление, как только поставщик ответит.
```

**API-вызов:** `POST /orders` с телом `{buyer_id, supplier_id, items[], delivery_address, delivery_date, notes}`

#### FR-3.6 Хранение корзины

| Параметр | Значение |
|----------|----------|
| Хранилище | Redis (ключ: `cart:{telegram_user_id}`) |
| TTL | 24 часа |
| Формат | JSON: `{supplier_id: [{offer_id, qty, unit_price}]}` |
| Очистка | Автоматическая по TTL + ручная по команде |

---

### 4.4 Модуль: Управление заказами

#### FR-4.1 Уведомление поставщика о новом заказе

```
Бот → Поставщик:

     Новый заказ #1042
     от: Цветочный рай (+7 999 123-45-67)
     Дата доставки: 24.02.2026

     1. Роза Ред Наоми 60 см
        25 шт × 95 руб. = 2 375 руб.
     2. Эустома белая 70 см
        10 шт × 180 руб. = 1 800 руб.

     Итого: 4 175 руб.

     [Подтвердить]  [Отклонить]
```

#### FR-4.2 Подтверждение заказа

```
Поставщик: (нажимает "Подтвердить")

Бот → Поставщик: Заказ #1042 подтверждён.

Бот → Покупатель: Заказ #1042 подтверждён!
                  Поставщик: Росцветторг
                  Телефон: +7 999 000-00-00
                  Адрес базы: ул. Цветочная, 5
```

**API-вызов:** `POST /suppliers/{id}/orders/confirm` с `{order_id}`

#### FR-4.3 Отклонение заказа

```
Поставщик: (нажимает "Отклонить")

Бот: Укажите причину:
     [Нет в наличии]
     [Изменилась цена]
     [Минимальный заказ не выполнен]
     [Другое]

Поставщик: (нажимает "Нет в наличии")

Бот → Поставщик: Заказ #1042 отклонён (причина: Нет в наличии).

Бот → Покупатель: Заказ #1042 отклонён.
                  Причина: Нет в наличии
                  Попробуйте найти аналогичный товар у другого поставщика.
                  [Найти аналоги]
```

**API-вызов:** `POST /suppliers/{id}/orders/reject` с `{order_id, reason}`

#### FR-4.4 Список заказов (/orders)

**Для поставщика:**
```
Бот: Ваши заказы:

     Ожидают подтверждения (2):
     • #1042 — Цветочный рай — 4 175 руб. — сегодня
       [Подтвердить] [Отклонить]
     • #1043 — Букет-Мастер — 8 900 руб. — сегодня
       [Подтвердить] [Отклонить]

     Подтверждённые (5):
     • #1039 — Флора — 12 000 руб. — вчера
     ...
```

**Для покупателя:**
```
Бот: Ваши заказы:

     Активные:
     • #1042 — Росцветторг — 4 175 руб. — ожидает подтверждения
     • #1040 — Самшит — 2 250 руб. — подтверждён

     Завершённые (последние 5):
     • #1035 — Росцветторг — 6 800 руб. — выполнен
     ...
```

---

### 4.5 Модуль: Уведомления

#### FR-5.1 Матрица уведомлений

| Событие | Получатель | Приоритет | Время отправки |
|---------|------------|-----------|----------------|
| Новый заказ | Поставщик | Высокий | Мгновенно + повтор через 15 мин если нет реакции |
| Заказ подтверждён | Покупатель | Высокий | Мгновенно |
| Заказ отклонён | Покупатель | Высокий | Мгновенно |
| Прайс обработан | Поставщик | Средний | Мгновенно |
| Ошибка импорта | Поставщик | Средний | Мгновенно |
| Прайс устарел (>7 дней) | Поставщик | Низкий | Ежедневно в 9:00 МСК |
| Аккаунт активирован | Поставщик/Покупатель | Средний | Мгновенно |

#### FR-5.2 Механизм доставки

1. При наступлении события (новый заказ, результат импорта и т.д.) API создаёт запись в `notification_queue` со статусом `pending`.
2. Notification Worker (фоновый процесс в боте) опрашивает API каждые 5 секунд.
3. Worker получает pending-уведомления, отправляет через Telegram API, помечает как `sent`.
4. При ошибке отправки — `retry_count += 1`, повтор через 30 сек. Максимум 3 попытки, затем `status=failed`.

#### FR-5.3 Повторные уведомления о заказах

Если поставщик не отреагировал на заказ в течение 15 минут:
- Отправляется повторное уведомление с пометкой "Напоминание"
- Максимум 3 напоминания (15 мин, 1 час, 3 часа)
- После 3 часов без реакции — уведомление администратору

---

## 5. Команды бота

### 5.1 Общие команды

| Команда | Описание | Доступ |
|---------|----------|--------|
| `/start` | Регистрация / главное меню | Все |
| `/help` | Справка по командам | Все |
| `/orders` | Список заказов | Привязанные |
| `/unlink` | Отвязать Telegram-аккаунт | Привязанные |
| `/status` | Статус аккаунта | Привязанные |

### 5.2 Команды поставщика

| Команда | Описание |
|---------|----------|
| `/price` | Информация о последнем прайсе + инструкция |
| `/stats` | Статистика: позиций в прайсе, заказов за неделю |

### 5.3 Команды покупателя

| Команда | Описание |
|---------|----------|
| `/search <запрос>` | Поиск товаров (или просто текстом) |
| `/cart` | Просмотр корзины |

### 5.4 Текстовые сообщения

| Ситуация | Поведение |
|----------|-----------|
| Покупатель пишет текст | Интерпретируется как поисковый запрос |
| Поставщик пишет текст | Бот предлагает: "Чтобы загрузить прайс, отправьте файл" |
| Отправлен файл (поставщик) | Запускается импорт |
| Отправлен файл (покупатель) | "Загрузка файлов доступна только поставщикам" |

---

## 6. Новые API-эндпоинты

### 6.1 Internal Telegram Router

Доступ: только с `127.0.0.1` + заголовок `X-Bot-Token: {TELEGRAM_INTERNAL_TOKEN}`

**Базовый путь:** `POST /internal/telegram/`

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/verify-phone` | Найти supplier/buyer по номеру телефона |
| POST | `/verify-code` | Проверить и использовать код привязки |
| POST | `/link` | Создать привязку telegram_user_id → entity |
| DELETE | `/link/{telegram_user_id}` | Отвязать аккаунт |
| GET | `/link/{telegram_user_id}` | Получить привязку (роль, entity_id, статус) |
| POST | `/generate-code` | Создать код привязки (из web-кабинета) |
| GET | `/pending-notifications` | Неотправленные уведомления (limit=50) |
| POST | `/ack-notification/{id}` | Подтвердить отправку уведомления |
| POST | `/fail-notification/{id}` | Пометить ошибку доставки |

### 6.2 Доработки существующих эндпоинтов

| Эндпоинт | Изменение |
|----------|-----------|
| `POST /orders` | Добавить создание записи в `notification_queue` (event_type=`new_order`) |
| `POST /suppliers/{id}/orders/confirm` | Добавить запись в `notification_queue` (event_type=`order_confirmed`) |
| `POST /suppliers/{id}/orders/reject` | Добавить запись в `notification_queue` (event_type=`order_rejected`) |
| `POST /suppliers/{id}/imports/*` | Добавить запись в `notification_queue` (event_type=`import_complete` или `import_error`) |

---

## 7. Структура кода

```
apps/bot/
├── __init__.py
├── main.py                      # Entry point: webhook setup, application init
├── config.py                    # Settings: BOT_TOKEN, API_URL, REDIS_URL
├── api_client.py                # Async HTTP client → FastAPI (httpx)
│
├── handlers/
│   ├── __init__.py
│   ├── start.py                 # /start, выбор роли, привязка
│   ├── supplier_upload.py       # Приём файлов, отображение результата
│   ├── supplier_orders.py       # Список заказов, подтверждение/отклонение
│   ├── buyer_search.py          # Текстовый поиск, отображение результатов
│   ├── buyer_cart.py            # Корзина: добавление, просмотр, оформление
│   ├── orders.py                # /orders — общий для обеих ролей
│   └── common.py                # /help, /status, /unlink, error handler
│
├── notifications/
│   ├── __init__.py
│   ├── worker.py                # Фоновый опрос notification_queue
│   └── templates.py             # Шаблоны сообщений (Markdown)
│
├── keyboards/
│   ├── __init__.py
│   ├── onboarding.py            # Inline keyboards: роль, телефон, регистрация
│   ├── orders.py                # Подтвердить/Отклонить, причины отклонения
│   └── catalog.py               # В корзину, Показать ещё, Оформить
│
└── state/
    ├── __init__.py
    └── cart.py                  # Redis-backed cart: add, remove, get, clear
```

**Итого:** ~20 файлов, ~1500-2000 строк кода.

---

## 8. Конфигурация и деплой

### 8.1 Переменные окружения (.env)

```env
# Telegram Bot
TELEGRAM_BOT_TOKEN=7123456789:AAH...
TELEGRAM_WEBHOOK_URL=https://158.160.229.16/flower/bot/webhook
TELEGRAM_WEBHOOK_SECRET=<random-32-char-string>
TELEGRAM_INTERNAL_TOKEN=<random-32-char-string>

# Redis
REDIS_URL=redis://localhost:6379/1
```

### 8.2 Systemd-сервис

Файл: `/etc/systemd/system/flower-bot.service`

```ini
[Unit]
Description=Flower Market Telegram Bot
After=flower-api.service redis.service

[Service]
User=ubuntu
WorkingDirectory=/opt/flower-market
ExecStart=/opt/flower-market/venv/bin/python -m apps.bot.main
Restart=always
RestartSec=5
EnvironmentFile=/opt/flower-market/.env

[Install]
WantedBy=multi-user.target
```

### 8.3 Nginx

Добавить в существующую конфигурацию:

```nginx
location /flower/bot/webhook {
    proxy_pass http://127.0.0.1:8081;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    # Только Telegram
    # (опционально: ограничить по IP-диапазонам Telegram)
}
```

### 8.4 Зависимости (requirements.txt)

```
# Telegram Bot
python-telegram-bot>=21.0
redis>=5.0.0
```

### 8.5 Деплой

Обновить `deploy.sh`:

```bash
# После перезапуска API:
sudo systemctl restart flower-bot
```

---

## 9. Безопасность

| Угроза | Мера |
|--------|------|
| Подмена webhook | Проверка `X-Telegram-Bot-Api-Secret-Token` заголовка |
| Несанкционированный доступ к internal API | Проверка IP (127.0.0.1) + `X-Bot-Token` |
| Спам-загрузка файлов | Rate limit: 1 файл/минуту на пользователя |
| Перебор кодов привязки | Код истекает через 24ч, 5 попыток → блок на 1 час |
| Утечка BOT_TOKEN | Хранится в `.env`, не в коде |
| XSS через Telegram | Markdown-экранирование всех пользовательских данных |

---

## 10. Мониторинг и логирование

| Метрика | Описание |
|---------|----------|
| `bot.messages.received` | Кол-во входящих сообщений |
| `bot.files.uploaded` | Кол-во загруженных прайсов |
| `bot.orders.created` | Кол-во заказов через бота |
| `bot.notifications.sent` | Кол-во отправленных уведомлений |
| `bot.notifications.failed` | Кол-во неудачных доставок |
| `bot.api.errors` | Ошибки при обращении к API |

Логирование: `structlog` (единообразно с API), формат JSON, вывод в journald.

---

## 11. Ограничения MVP-версии бота

Следующие возможности **НЕ входят** в первую версию:

- Групповые чаты (бот работает только в личных сообщениях)
- Inline-режим (поиск через @bot_name в любом чате)
- Оплата через Telegram Payments
- Мультиязычность (только русский)
- Интеграция с CRM / 1С
- Push-уведомления для web (только Telegram)
- Аналитические дашборды в боте
- Голосовые сообщения и фото-поиск

---

## 12. План реализации (этапы)

| Этап | Название | Содержание | Зависимости |
|------|----------|------------|-------------|
| **E1** | Каркас + Onboarding | Структура проекта, webhook, /start, привязка по телефону и коду | Миграция БД (3 таблицы), Redis |
| **E2** | Загрузка прайса | Приём файлов, вызов API импорта, отображение результата | E1, существующий import pipeline |
| **E3** | Заказы поставщика | Уведомление о заказе, подтверждение/отклонение, /orders | E1, notification_queue |
| **E4** | Поиск и корзина | Текстовый поиск, корзина (Redis), оформление заказа | E1, Redis |
| **E5** | Уведомления | Notification Worker, напоминания, устаревший прайс | E3 |
| **E6** | Тестирование и деплой | Unit/integration тесты, деплой на сервер, smoke test | E1-E5 |

---

## 13. Критерии приёмки

Бот считается готовым к production, если:

- [ ] Поставщик может привязать аккаунт через номер телефона
- [ ] Поставщик может загрузить прайс (CSV/XLSX/PDF) и увидеть результат
- [ ] Поставщик получает уведомление о новом заказе в течение 10 секунд
- [ ] Поставщик может подтвердить или отклонить заказ через inline-кнопки
- [ ] Покупатель может найти товар текстовым поиском
- [ ] Покупатель может добавить товар в корзину и оформить заказ
- [ ] Покупатель получает уведомление о статусе заказа
- [ ] Бот корректно обрабатывает ошибки (API недоступен, неверный формат и т.д.)
- [ ] Бот запускается как systemd-сервис и переживает перезагрузку сервера
- [ ] Логи пишутся в journald в формате JSON

---

## 14. Согласование

| Роль | ФИО | Дата | Подпись |
|------|-----|------|---------|
| Заказчик | | | |
| Разработчик | | | |

---

**Примечания:**
- Данное ТЗ описывает MVP-версию бота. Расширения (inline-режим, оплата, мультиязычность) — отдельные задачи.
- Бот использует существующую инфраструктуру (API, БД, сервер). Дополнительного сервера не требуется.
- Для работы бота необходимо создать бота через @BotFather и получить токен.
