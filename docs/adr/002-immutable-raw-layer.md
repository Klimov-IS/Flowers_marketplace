# ADR-002: Immutable RAW layer

## Статус

Accepted

## Дата

2025-01-12

## Контекст

При импорте CSV-прайсов нужно решить, как хранить исходные данные:

1. **Parse and discard**: парсить и хранить только структурированные данные
2. **Mutable storage**: хранить raw, но позволять исправления
3. **Immutable storage**: хранить raw без изменений навсегда

Требования:
- Возможность debug при ошибках парсинга
- Audit trail для спорных ситуаций
- Возможность перепарсить при улучшении алгоритма
- Сохранение истории изменений прайсов

## Решение

Использовать **immutable RAW layer**:

1. `import_batches` — метаданные загрузки
2. `raw_rows` — исходные строки CSV, НИКОГДА не изменяются
3. `parse_runs` + `parse_events` — логи парсинга

Принципы:
- RAW данные создаются один раз при импорте
- Исправления делаются через dictionary/mappings, не через raw
- Перепарсинг создаёт новые записи, не меняет старые
- Архивирование через retention policy, не удаление

## Последствия

### Плюсы

- **Audit trail**: всегда можно посмотреть оригинал
- **Debugging**: легко понять, откуда взялась ошибка
- **Re-parsing**: можно перепарсить с новыми правилами
- **Data integrity**: невозможно случайно испортить данные
- **Compliance**: соответствие требованиям аудита

### Минусы

- **Storage**: требуется больше места
- **Complexity**: дополнительный слой в архитектуре
- **Migration**: сложнее мигрировать схему raw данных

### Mitigation

- Cold storage для старых данных (>90 дней)
- Compression для raw_rows
- Retention policy: архивация, не удаление

## Альтернативы

### Parse and discard

- Плюс: простота, меньше хранения
- Минус: потеря информации, сложный debug

### Mutable storage

- Плюс: можно "исправить" ошибки
- Минус: потеря audit trail, сложнее понять историю

## Связанные решения

- RAW → PARSED → NORMALIZED → PUBLISHED слои
- Soft delete вместо hard delete
- Event sourcing для parse events
