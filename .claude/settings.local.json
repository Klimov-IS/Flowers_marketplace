{
  "permissions": {
    "allow": [
      "Bash(dir:*)",
      "Bash(mkdir:*)",
      "Bash(docker compose:*)",
      "Bash(python:*)",
      "Bash(pnpm create:*)",
      "Bash(npm --version)",
      "Bash(npm create:*)",
      "Bash(npm install)",
      "Bash(npm install:*)",
      "Bash(npx tailwindcss init:*)",
      "Bash(npm run dev)",
      "Bash(npm uninstall:*)",
      "Bash(taskkill:*)",
      "Bash(npx tsc:*)",
      "Bash(cp:*)",
      "Bash(timeout:*)",
      "Bash(wc:*)",
      "Bash(git init:*)",
      "Bash(git remote add:*)",
      "Bash(git add:*)",
      "Bash(git branch:*)",
      "Bash(git push:*)",
      "Bash(ls -la \"c:\\\\Users\\\\79025\\\\Desktop\\\\проекты\\\\Маркетплейс\\\\docs\\\\Прайсы\"\" 2>/dev/null || dir \"c:Users79025DesktopпроектыМаркетплейсdocsПрайсы \")",
      "Bash(git mv:*)",
      "Bash(git rm:*)",
      "Bash(docker --version:*)",
      "Bash(docker ps:*)",
      "Bash(source venv/Scripts/activate)",
      "Bash(pip install:*)",
      "Bash(alembic upgrade:*)",
      "Bash(grep:*)",
      "Bash(docker exec:*)",
      "Bash(curl:*)",
      "Bash(netstat:*)",
      "Bash(tasklist:*)",
      "Bash(findstr:*)",
      "Bash(.venvScriptspython.exe -c \"import apps.api.models; print\\(''Models OK''\\)\")",
      "Bash(.venv/Scripts/python.exe:*)",
      "Bash(./venv/Scripts/python.exe:*)",
      "Bash(pkill:*)",
      "Bash(ssh -i ~/.ssh/yandex-cloud-wb-reputation ubuntu@158.160.217.236 '\n# Generate secure password\nDB_PASSWORD=$\\(openssl rand -base64 24 | tr -dc \"\"a-zA-Z0-9\"\" | head -c 24\\)\necho \"\"Generated DB password: $DB_PASSWORD\"\"\n\n# Create docker-compose.db.yml\ncat > /opt/flower-market/docker-compose.db.yml << EOF\nservices:\n  flower_db:\n    image: postgres:16-alpine\n    container_name: flower_postgres\n    restart: unless-stopped\n    environment:\n      POSTGRES_DB: flower_market\n      POSTGRES_USER: flower_user\n      POSTGRES_PASSWORD: ${DB_PASSWORD}\n    volumes:\n      - flower_pgdata:/var/lib/postgresql/data\n    ports:\n      - \"\"127.0.0.1:5433:5432\"\"\n    healthcheck:\n      test: [\"\"CMD-SHELL\"\", \"\"pg_isready -U flower_user -d flower_market\"\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n\nvolumes:\n  flower_pgdata:\nEOF\n\n# Create .env file\ncat > /opt/flower-market/.env << EOF\n# Database\nDB_HOST=127.0.0.1\nDB_PORT=5433\nDB_NAME=flower_market\nDB_USER=flower_user\nDB_PASSWORD=${DB_PASSWORD}\n\n# Application\nAPP_ENV=production\nLOG_LEVEL=INFO\nAPI_HOST=0.0.0.0\nAPI_PORT=8080\n\n# JWT Secret\nJWT_SECRET_KEY=$\\(openssl rand -base64 32\\)\nEOF\n\necho \"\"=== FILES CREATED ===\"\"\nls -la /opt/flower-market/\necho -e \"\"\\\\n=== .env content \\(masked\\) ===\"\"\ncat /opt/flower-market/.env | sed \"\"s/PASSWORD=.*/PASSWORD=***HIDDEN***/\"\" | sed \"\"s/SECRET_KEY=.*/SECRET_KEY=***HIDDEN***/\"\"\n')",
      "Bash(ssh -i ~/.ssh/yandex-cloud-wb-reputation ubuntu@158.160.217.236 '\n# Need to re-login for docker group, use sudo for now\necho \"\"=== STARTING POSTGRESQL ===\"\"\ncd /opt/flower-market\nsudo docker compose -f docker-compose.db.yml up -d\n\necho -e \"\"\\\\n=== WAITING FOR POSTGRES ===\"\"\nsleep 5\nsudo docker ps\n\necho -e \"\"\\\\n=== TESTING CONNECTION ===\"\"\nsudo docker exec flower_postgres pg_isready -U flower_user -d flower_market\n')",
      "Bash(ssh -i ~/.ssh/yandex-cloud-wb-reputation ubuntu@158.160.217.236 '\n# Create systemd service file\nsudo tee /etc/systemd/system/flower-api.service > /dev/null << EOF\n[Unit]\nDescription=Flower Market API\nAfter=network.target docker.service\nRequires=docker.service\n\n[Service]\nType=simple\nUser=ubuntu\nWorkingDirectory=/opt/flower-market\nEnvironment=\"\"PATH=/opt/flower-market/venv/bin:/usr/bin\"\"\nEnvironmentFile=/opt/flower-market/.env\nExecStart=/opt/flower-market/venv/bin/uvicorn apps.api.main:app --host 0.0.0.0 --port 8080\nRestart=always\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\necho \"\"=== SYSTEMD SERVICE CREATED ===\"\"\ncat /etc/systemd/system/flower-api.service\n')",
      "Bash(ssh -i ~/.ssh/yandex-cloud-wb-reputation ubuntu@158.160.217.236 '\n# Create nginx config for flower market\nsudo tee /etc/nginx/sites-available/flower-market > /dev/null << EOF\n# Flower Market - path-based routing\n# Add these location blocks to the existing server block\n\n# This is a separate file, will be included or merged manually\n# For now, we add to main config\n\nlocation /flower/api/ {\n    proxy_pass http://127.0.0.1:8080/;\n    proxy_http_version 1.1;\n    proxy_set_header Host \\\\$host;\n    proxy_set_header X-Real-IP \\\\$remote_addr;\n    proxy_set_header X-Forwarded-For \\\\$proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto \\\\$scheme;\n    proxy_connect_timeout 60s;\n    proxy_send_timeout 60s;\n    proxy_read_timeout 60s;\n}\n\nlocation /flower/ {\n    alias /opt/flower-market/frontend/dist/;\n    try_files \\\\$uri \\\\$uri/ /flower/index.html;\n}\n\nlocation /flower/assets/ {\n    alias /opt/flower-market/frontend/dist/assets/;\n    expires 1y;\n    add_header Cache-Control \"\"public, immutable\"\";\n}\nEOF\n\n# Read current nginx config\necho \"\"=== CURRENT NGINX CONFIG ===\"\"\ncat /etc/nginx/sites-available/wb-reputation\n\necho -e \"\"\\\\n=== FLOWER MARKET LOCATIONS TO ADD ===\"\"\ncat /etc/nginx/sites-available/flower-market\n')",
      "Bash(ssh -i ~/.ssh/yandex-cloud-wb-reputation ubuntu@158.160.217.236 '\n# Create updated nginx config with both projects\nsudo tee /etc/nginx/sites-available/wb-reputation > /dev/null << EOF\nserver {\n    listen 80;\n    server_name 158.160.217.236;\n\n    gzip on;\n    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;\n\n    # ============================================\n    # Flower Market - /flower/ path\n    # ============================================\n    \n    location /flower/api/ {\n        proxy_pass http://127.0.0.1:8080/;\n        proxy_http_version 1.1;\n        proxy_set_header Host \\\\$host;\n        proxy_set_header X-Real-IP \\\\$remote_addr;\n        proxy_set_header X-Forwarded-For \\\\$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \\\\$scheme;\n        proxy_connect_timeout 60s;\n        proxy_send_timeout 60s;\n        proxy_read_timeout 60s;\n    }\n\n    location /flower/assets/ {\n        alias /opt/flower-market/frontend/dist/assets/;\n        expires 1y;\n        add_header Cache-Control \"\"public, immutable\"\";\n    }\n\n    location /flower/ {\n        alias /opt/flower-market/frontend/dist/;\n        try_files \\\\$uri \\\\$uri/ /flower/index.html;\n    }\n\n    # ============================================\n    # WB Reputation - root path \\(existing\\)\n    # ============================================\n\n    location /_next/static {\n        proxy_pass http://localhost:3000;\n        proxy_cache_valid 200 60m;\n        add_header Cache-Control \"\"public, max-age=3600, immutable\"\";\n    }\n\n    location /health {\n        access_log off;\n        return 200 \"\"OK\\\\n\"\";\n        add_header Content-Type text/plain;\n    }\n\n    location / {\n        proxy_pass http://localhost:3000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade \\\\$http_upgrade;\n        proxy_set_header Connection \"\"upgrade\"\";\n        proxy_set_header Host \\\\$host;\n        proxy_set_header X-Real-IP \\\\$remote_addr;\n        proxy_set_header X-Forwarded-For \\\\$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \\\\$scheme;\n        proxy_cache_bypass \\\\$http_upgrade;\n        \n        proxy_connect_timeout 300s;\n        proxy_send_timeout 300s;\n        proxy_read_timeout 300s;\n    }\n}\nEOF\n\necho \"\"=== TESTING NGINX CONFIG ===\"\"\nsudo nginx -t\n\necho -e \"\"\\\\n=== CONFIG UPDATED \\(not reloaded yet\\) ===\"\"\n')",
      "Bash(ssh -i ~/.ssh/yandex-cloud-wb-reputation ubuntu@158.160.217.236 '\n# Create deploy script\ncat > /opt/flower-market/deploy.sh << \"\"DEPLOY_EOF\"\"\n#!/bin/bash\nset -e\n\ncd /opt/flower-market\n\necho \"\"=== FLOWER MARKET DEPLOY ===\"\"\necho \"\"Time: $\\(date\\)\"\"\n\n# Pull latest code \\(if git repo exists\\)\nif [ -d \"\".git\"\" ]; then\n    echo \"\"Pulling latest code...\"\"\n    git pull origin main\nfi\n\n# Backend setup\necho \"\"Setting up Python environment...\"\"\nif [ ! -d \"\"venv\"\" ]; then\n    python3 -m venv venv\nfi\nsource venv/bin/activate\npip install -q -r requirements.txt\n\n# Run migrations\necho \"\"Running database migrations...\"\"\nalembic upgrade head\n\n# Build frontend\necho \"\"Building frontend...\"\"\ncd frontend\nnpm ci --silent\nVITE_API_BASE_URL=/flower/api npm run build\ncd ..\n\n# Restart services\necho \"\"Restarting services...\"\"\nsudo systemctl daemon-reload\nsudo systemctl restart flower-api\nsudo systemctl enable flower-api\n\n# Reload nginx\nsudo nginx -t && sudo systemctl reload nginx\n\necho \"\"=== DEPLOY COMPLETE ===\"\"\necho \"\"Frontend: http://158.160.217.236/flower/\"\"\necho \"\"API: http://158.160.217.236/flower/api/\"\"\nDEPLOY_EOF\n\nchmod +x /opt/flower-market/deploy.sh\n\necho \"\"=== DEPLOY SCRIPT CREATED ===\"\"\ncat /opt/flower-market/deploy.sh\n')",
      "Bash(rsync:*)",
      "Bash(scp:*)",
      "Bash(ssh -i ~/.ssh/yandex-cloud-wb-reputation ubuntu@158.160.217.236 '\ncd /opt/flower-market\necho \"\"=== EXTRACTING ARCHIVE ===\"\"\ntar -xzf flower-market.tar.gz\nrm flower-market.tar.gz\n\necho -e \"\"\\\\n=== PROJECT STRUCTURE ===\"\"\nls -la\n\necho -e \"\"\\\\n=== APPS STRUCTURE ===\"\"\nls -la apps/api/\n')",
      "Bash(ssh -i ~/.ssh/yandex-cloud-wb-reputation ubuntu@158.160.217.236 '\ncd /opt/flower-market\n\n# Restore production .env \\(read password from docker-compose\\)\nDB_PASSWORD=$\\(grep \"\"POSTGRES_PASSWORD\"\" docker-compose.db.yml | cut -d\"\":\"\" -f2 | tr -d \"\" \"\"\\)\nJWT_SECRET=$\\(openssl rand -base64 32\\)\n\ncat > .env << EOF\n# Database\nDB_HOST=127.0.0.1\nDB_PORT=5433\nDB_NAME=flower_market\nDB_USER=flower_user\nDB_PASSWORD=${DB_PASSWORD}\n\n# Application\nAPP_ENV=production\nLOG_LEVEL=INFO\nAPI_HOST=0.0.0.0\nAPI_PORT=8080\n\n# JWT Secret\nJWT_SECRET_KEY=${JWT_SECRET}\n\n# CORS\nCORS_ORIGINS=http://158.160.217.236\nEOF\n\necho \"\"=== .env RESTORED ===\"\"\ncat .env | sed \"\"s/PASSWORD=.*/PASSWORD=***/\"\" | sed \"\"s/SECRET_KEY=.*/SECRET_KEY=***/\"\"\n')",
      "Bash(ssh -i ~/.ssh/yandex-cloud-wb-reputation ubuntu@158.160.217.236 '\ncd /opt/flower-market\n\necho \"\"=== SETTING UP PYTHON VENV ===\"\"\npython3 -m venv venv\nsource venv/bin/activate\n\necho \"\"=== INSTALLING PYTHON DEPENDENCIES ===\"\"\npip install --upgrade pip\npip install -r requirements.txt\n')",
      "Bash(ssh:*)",
      "Bash(tar -czvf:*)",
      "Bash(ssh-add:*)",
      "Bash(tree:*)",
      "Bash(tar:*)",
      "Bash(pip show:*)",
      "Bash(npm run build:*)",
      "Bash(powershell -Command \"scp -o StrictHostKeyChecking=no ''C:\\\\Users\\\\79025\\\\Desktop\\\\проекты\\\\Маркетплейс\\\\deploy.tar.gz'' root@31.128.37.216:/opt/flower-marketplace/\")",
      "Bash(venvScriptspython -m pytest tests/unit/test_ai_enrichment.py -v)",
      "Bash(\"venv/Scripts/python.exe\" -m pytest tests/unit/test_ai_enrichment.py -v)",
      "Bash(\"venv/Scripts/python.exe\" -m alembic revision --autogenerate -m \"add_deleted_at_to_supplier_items\")",
      "Bash(\"venv/Scripts/python.exe\" -m alembic upgrade head)",
      "Bash(.venvScriptspython.exe -c \"from apps.api.models.catalog import FlowerType, FlowerSubtype, FlowerVariety; print\\(''Models import OK''\\)\")",
      "Bash(venvScriptspython.exe -c \"from apps.api.models.catalog import FlowerType, FlowerSubtype, FlowerVariety; print\\(''Models import OK''\\)\")",
      "Bash(\"venv/Scripts/python.exe\" -c \"from apps.api.models.catalog import FlowerType, FlowerSubtype, FlowerVariety; print\\(''Models import OK''\\)\")",
      "Bash(\"venv/Scripts/python.exe\" -c \"from apps.api.routers.catalog import router; print\\(''Router import OK''\\)\")",
      "Bash(\"venv/Scripts/python.exe\":*)",
      "Bash(\"venv/Scripts/python.exe\" -c:*)",
      "Bash(\"venv/Scripts/python.exe\" -c \"from apps.api.main import app; print\\(f''App routes: {len\\(app.routes\\)}''\\)\")",
      "Bash(.venvScriptspython.exe -m pytest tests/unit/test_ai_enrichment.py -v --tb=short)",
      "Bash(\"venv/Scripts/python.exe\" -m pytest tests/unit/test_ai_enrichment.py -v --tb=short)",
      "Bash(\"venv/Scripts/python.exe\" -m pytest tests/unit/ -v --tb=short -q)",
      "Bash(\"venv/Scripts/python.exe\" -m pytest:*)",
      "Bash(ls:*)",
      "Bash(git status:*)",
      "Bash(git reset:*)",
      "Bash(python3:*)",
      "Bash(.venvScriptspython.exe -m pytest tests/unit/test_catalog_filters.py -v)",
      "Bash(\"venv\\\\Scripts\\\\python.exe\" -m pytest tests/unit/test_catalog_filters.py -v)",
      "Bash(find:*)",
      "Bash(git diff:*)",
      "WebFetch(domain:158.160.217.236)",
      "Bash(iconv:*)",
      "Bash(alembic revision:*)",
      "Bash(docker info:*)",
      "Bash(start \"\" \"C:\\\\Program Files\\\\Docker\\\\Docker\\\\Docker Desktop.exe\")",
      "Bash(powershell -Command:*)",
      "Bash(ping:*)",
      "Bash(wmic process where \"name=''python.exe''\" get ProcessId,CommandLine /FORMAT:LIST)",
      "Bash(wmic process where \"commandline like ''%uvicorn apps.api.main%'' and name=''python.exe''\" get processid /format:list)",
      "Bash(powershell:*)",
      "Bash(cmd /c \"type c:\\\\Users\\\\79025\\\\Desktop\\\\проекты\\\\Маркетплейс\\\\.env | findstr /i TELEGRAM\")"
    ],
    "deny": [],
    "ask": []
  }
}
